<!DOCTYPE html>
<html lang="en" data-theme="marshmallow">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>BPM — BentoBase Performance Manager</title>
<style>
/* ========================================
   BPM (BentoBase Performance Manager) — Design System
   ======================================== */

/* --- Theme Tokens --- */
:root {
  --bg: #f7f7f7;
  --panel: #efefef;
  --panel2: #ffffff;
  --text: #141414;
  --muted: #4a4a4a;
  --border: #141414;
  --focus: #7c5b45;
  --accentBg: #5b4133;
  --accentText: #f7f7f7;
  --icon-filter: none;
  --runPassed: #6b8f71;
  --runFailed: #b87070;
  --runRunning: #c4a26e;
}

html[data-theme="mocha"] {
  --bg: #1b1613; --panel: #2b231e; --panel2: #362b25;
  --text: #f3ece6; --muted: #c7b7ad; --border: #f3ece6;
  --focus: #e2b88f; --accentBg: #e2b88f; --accentText: #1b1613;
  --icon-filter: invert(1);
  --runPassed: #7fa97e; --runFailed: #c47676; --runRunning: #dbb870;
}

html[data-theme="disco"] {
  --bg: #120b1f; --panel: #1a1030; --panel2: #231246;
  --text: #f6f3ff; --muted: #c6b8ff; --border: #f6f3ff;
  --focus: #00f5ff; --accentBg: #ff3df4; --accentText: #120b1f;
  --icon-filter: invert(1);
  --runPassed: #7dffb0; --runFailed: #ff7a7a; --runRunning: #ffcc00;
}

html[data-theme="ronswanson"] {
  --bg: #0f1620; --panel: #1a2533; --panel2: #223142;
  --text: #f2f7fb; --muted: #b9c9d6; --border: #f2f7fb;
  --focus: #f6c177; --accentBg: #f6c177; --accentText: #0f1620;
  --icon-filter: invert(1);
  --runPassed: #7fa97e; --runFailed: #c47676; --runRunning: #e6b45e;
}

html[data-theme="gringo"] {
  --bg: #f3e8d9; --panel: #f8f1e7; --panel2: #ffffff;
  --text: #1d1a16; --muted: #5b5148; --border: #1d1a16;
  --focus: #0a8f6a; --accentBg: #d3f0e6; --accentText: #1d1a16;
  --icon-filter: none;
  --runPassed: #2e7d32; --runFailed: #b44; --runRunning: #c49000;
}

html[data-theme="matrix"] {
  --bg: #050b06; --panel: #07140b; --panel2: #0b1f12;
  --text: #00ff66; --muted: #7dffb0; --border: #00c650;
  --focus: #00ff66; --accentBg: #00c650; --accentText: #050b06;
  --icon-filter: invert(1);
  --runPassed: #00ff66; --runFailed: #ff4444; --runRunning: #ffcc00;
}

/* --- Reset & Base --- */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  font-size: 14px;
  color: var(--text);
  background: var(--bg);
  -webkit-font-smoothing: antialiased;
  overflow: hidden;
}

::selection {
  background: color-mix(in srgb, var(--focus) 30%, transparent);
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb {
  background: color-mix(in srgb, var(--muted) 30%, transparent);
  border-radius: 3px;
}
::-webkit-scrollbar-thumb:hover {
  background: color-mix(in srgb, var(--muted) 50%, transparent);
}

/* --- Shell Layout --- */
.shell {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.shell-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 44px;
  padding: 0 16px;
  background: var(--panel);
  border-bottom: 1px solid color-mix(in srgb, var(--border) 12%, transparent);
  box-sizing: border-box;
  flex-shrink: 0;
  z-index: 100;
}

.shell-header-left {
  display: flex;
  align-items: center;
}

.shell-header-right {
  display: flex;
  align-items: center;
  gap: 8px;
}

.shell-logo {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: transparent;
  border: none;
  border-radius: 8px;
  color: var(--muted);
  cursor: default;
  margin-right: 8px;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  transition: color 150ms ease;
}

.shell-logo svg {
  width: 18px;
  height: 18px;
}

.shell-nav {
  display: flex;
  gap: 0;
}

.shell-nav-btn {
  padding: 0 14px;
  height: 44px;
  display: flex;
  align-items: center;
  background: none;
  border: none;
  border-bottom: 1.5px solid transparent;
  color: var(--muted);
  font-size: 11px;
  font-weight: 500;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  cursor: pointer;
  transition: color 150ms ease, border-color 150ms ease;
}

.shell-nav-btn:hover {
  color: var(--text);
}

.shell-nav-btn.active {
  color: var(--text);
  font-weight: 600;
  border-bottom-color: var(--focus);
}


.theme-select {
  font-size: 11px;
  padding: 4px 8px;
  border: 1px solid color-mix(in srgb, var(--border) 15%, transparent);
  border-radius: 6px;
  background: var(--panel2);
  color: var(--text);
  cursor: pointer;
  outline: none;
}

.theme-select:focus { border-color: var(--focus); }

/* --- Main Content --- */
.main-content {
  flex: 1;
  overflow: hidden;
  display: flex;
  min-width: 0;
}

.page {
  display: none;
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 28px 32px;
  min-width: 0;
}

.page.active { display: block; }

.page-title {
  font-size: 20px;
  font-weight: 600;
  letter-spacing: -0.02em;
  margin-bottom: 4px;
}

.page-subtitle {
  font-size: 13px;
  color: var(--muted);
  margin-bottom: 24px;
}

/* --- Buttons --- */
.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 14px;
  font-size: 12px;
  font-weight: 500;
  color: var(--text);
  background: transparent;
  border: 1px solid color-mix(in srgb, var(--border) 18%, transparent);
  border-radius: 6px;
  cursor: pointer;
  transition: all 150ms ease;
  letter-spacing: 0.02em;
  white-space: nowrap;
}

.btn:hover {
  background: color-mix(in srgb, var(--text) 5%, transparent);
  border-color: color-mix(in srgb, var(--border) 30%, transparent);
}

.btn-primary {
  background: color-mix(in srgb, var(--focus) 12%, transparent);
  color: var(--focus);
  border-color: color-mix(in srgb, var(--focus) 25%, transparent);
}

.btn-primary:hover {
  background: color-mix(in srgb, var(--focus) 20%, transparent);
  border-color: color-mix(in srgb, var(--focus) 40%, transparent);
}

.btn-accent {
  background: var(--accentBg);
  color: var(--accentText);
  border-color: transparent;
}

.btn-accent:hover { opacity: 0.9; }

.btn-danger {
  color: #e55;
  border-color: color-mix(in srgb, #e55 25%, transparent);
}

.btn-danger:hover {
  background: color-mix(in srgb, #e55 10%, transparent);
}

.btn-sm {
  padding: 4px 10px;
  font-size: 11px;
}

.btn-icon {
  padding: 5px;
  border: none;
  background: transparent;
  color: var(--muted);
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 150ms ease;
}

.btn-icon:hover {
  color: var(--text);
  background: color-mix(in srgb, var(--text) 6%, transparent);
}

.btn-icon svg { width: 16px; height: 16px; }

/* --- Cards --- */
.card {
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  border-radius: 10px;
  padding: 20px;
  transition: border-color 150ms ease, box-shadow 150ms ease;
}

.card:hover {
  border-color: color-mix(in srgb, var(--border) 15%, transparent);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}

.card-title {
  font-size: 13px;
  font-weight: 600;
  letter-spacing: -0.01em;
}

/* --- Badges --- */
.badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
  text-transform: uppercase;
  letter-spacing: 0.04em;
}

.badge-bug { background: color-mix(in srgb, #e55 15%, transparent); color: #e55; }
.badge-feature { background: color-mix(in srgb, var(--focus) 15%, transparent); color: var(--focus); }
.badge-enhancement { background: color-mix(in srgb, #8b5cf6 15%, transparent); color: #8b5cf6; }
.badge-refactor { background: color-mix(in srgb, #6b7a8d 15%, transparent); color: #6b7a8d; }
.badge-docs { background: color-mix(in srgb, #0a8f6a 15%, transparent); color: #0a8f6a; }

.badge-critical { background: color-mix(in srgb, #dc2626 15%, transparent); color: #dc2626; }
.badge-high { background: color-mix(in srgb, #ea580c 15%, transparent); color: #ea580c; }
.badge-medium { background: color-mix(in srgb, var(--runRunning) 15%, transparent); color: var(--runRunning); }
.badge-low { background: color-mix(in srgb, var(--muted) 15%, transparent); color: var(--muted); }

.badge-open { background: color-mix(in srgb, #3b82f6 15%, transparent); color: #3b82f6; }
.badge-progress { background: color-mix(in srgb, var(--runRunning) 15%, transparent); color: var(--runRunning); }
.badge-review { background: color-mix(in srgb, #8b5cf6 15%, transparent); color: #8b5cf6; }
.badge-done { background: color-mix(in srgb, var(--runPassed) 15%, transparent); color: var(--runPassed); }

/* --- Inputs --- */
.input, .textarea, .select {
  width: 100%;
  padding: 8px 12px;
  font-size: 13px;
  font-family: inherit;
  color: var(--text);
  background: color-mix(in srgb, var(--text) 3%, transparent);
  border: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
  border-radius: 6px;
  outline: none;
  transition: border-color 150ms ease;
}

.input:focus, .textarea:focus, .select:focus {
  border-color: var(--focus);
}

.input::placeholder, .textarea::placeholder {
  color: var(--muted);
  opacity: 0.5;
}

.textarea {
  resize: vertical;
  min-height: 80px;
  line-height: 1.5;
}

.select {
  cursor: pointer;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7a8d' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.form-label {
  font-size: 11px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
}

.form-row {
  display: flex;
  gap: 12px;
}

.form-row > * { flex: 1; }

/* --- Modal --- */
.modal-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  z-index: 10000;
  align-items: center;
  justify-content: center;
}

.modal-overlay.open { display: flex; }

.modal {
  background: var(--panel);
  border: 1px solid color-mix(in srgb, var(--border) 12%, transparent);
  border-radius: 14px;
  width: 560px;
  max-width: 92vw;
  max-height: 85vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 24px 64px rgba(0,0,0,0.35);
  animation: modalIn 200ms ease;
}

@keyframes modalIn {
  from { opacity: 0; transform: scale(0.96) translateY(8px); }
  to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 18px 22px;
  border-bottom: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
}

.modal-title {
  font-size: 15px;
  font-weight: 600;
}

.modal-body {
  padding: 22px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  padding: 14px 22px;
  border-top: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
}

/* --- Dashboard --- */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(180px, 100%), 1fr));
  gap: 12px;
  margin-bottom: 28px;
}

.stat-card {
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  border-radius: 10px;
  padding: 18px 20px;
}

.stat-label {
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
  margin-bottom: 6px;
}

.stat-value {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: -0.02em;
  color: var(--text);
}

.stat-sub {
  font-size: 11px;
  color: var(--muted);
  margin-top: 2px;
}

.section-title {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  margin-bottom: 12px;
}

/* --- Tracker --- */
.tracker-toolbar {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.tracker-search {
  flex: 1;
  min-width: 200px;
  padding: 7px 12px;
  font-size: 12px;
  color: var(--text);
  background: color-mix(in srgb, var(--text) 3%, transparent);
  border: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
  border-radius: 6px;
  outline: none;
  transition: border-color 150ms ease;
  font-family: inherit;
}

.tracker-search:focus { border-color: var(--focus); }
.tracker-search::placeholder { color: var(--muted); opacity: 0.5; }

.tracker-filter {
  padding: 6px 10px;
  font-size: 11px;
  color: var(--text);
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 12%, transparent);
  border-radius: 6px;
  cursor: pointer;
  outline: none;
  font-family: inherit;
  -webkit-appearance: none;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%236b7a8d' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 8px center;
  padding-right: 24px;
}

.tracker-filter:focus { border-color: var(--focus); }

.ticket-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.ticket-row {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 6%, transparent);
  border-radius: 8px;
  transition: all 150ms ease;
  cursor: pointer;
}

.ticket-row:hover {
  border-color: color-mix(in srgb, var(--border) 15%, transparent);
  background: color-mix(in srgb, var(--focus) 3%, transparent);
}

.ticket-row.done-row {
  opacity: 0.5;
}

.ticket-row.done-row .ticket-title {
  text-decoration: line-through;
}

.ticket-drag {
  color: var(--muted);
  opacity: 0.3;
  cursor: grab;
  flex-shrink: 0;
}

.ticket-drag:active { cursor: grabbing; }

.ticket-priority {
  width: 4px;
  height: 28px;
  border-radius: 2px;
  flex-shrink: 0;
}

.ticket-priority.p-critical { background: #dc2626; }
.ticket-priority.p-high { background: #ea580c; }
.ticket-priority.p-medium { background: var(--runRunning); }
.ticket-priority.p-low { background: color-mix(in srgb, var(--muted) 40%, transparent); }

.ticket-body { flex: 1; min-width: 0; }

.ticket-title {
  font-size: 13px;
  font-weight: 500;
  color: var(--text);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.ticket-meta {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 3px;
}

.ticket-id {
  font-size: 10px;
  font-weight: 500;
  color: var(--muted);
  opacity: 0.6;
  font-family: ui-monospace, SFMono-Regular, monospace;
}

.ticket-tags {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
}

.ticket-actions {
  display: flex;
  gap: 4px;
  flex-shrink: 0;
  opacity: 0;
  transition: opacity 150ms ease;
}

.ticket-row:hover .ticket-actions { opacity: 1; }

/* --- Ticket Images --- */
.ticket-thumb {
  width: 40px;
  height: 40px;
  border-radius: 6px;
  object-fit: cover;
  flex-shrink: 0;
}

.detail-hero-image {
  width: 100%;
  max-height: 240px;
  object-fit: cover;
  border-radius: 10px;
  border: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
}

.detail-image-actions {
  display: flex;
  gap: 8px;
  margin-top: 6px;
}

/* --- Notes --- */
.notes-list {
  display: flex;
  flex-direction: column;
  gap: 0;
}
.note-item {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  padding: 10px 0;
  border-bottom: 1px solid color-mix(in srgb, var(--border) 30%, transparent);
}
.note-item:last-child { border-bottom: none; }
.note-dot {
  width: 8px;
  height: 8px;
  min-width: 8px;
  border-radius: 50%;
  background: var(--focus);
  margin-top: 4px;
}
.note-body { flex: 1; min-width: 0; }
.note-content {
  font-size: 13px;
  line-height: 1.5;
  white-space: pre-wrap;
  word-break: break-word;
  color: var(--text);
}
.note-meta {
  font-size: 10px;
  color: var(--muted);
  margin-top: 3px;
}
.note-delete-btn {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--muted);
  opacity: 0.4;
  font-size: 14px;
  padding: 2px 4px;
  transition: opacity 0.15s, color 0.15s;
}
.note-delete-btn:hover {
  opacity: 1;
  color: #dc2626;
}
.note-form {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 10px;
}
.note-form textarea {
  width: 100%;
  min-height: 60px;
  padding: 8px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--card);
  color: var(--text);
  font-size: 13px;
  font-family: inherit;
  resize: vertical;
}
.note-form textarea:focus {
  outline: none;
  border-color: var(--focus);
}
.note-form-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.note-form-row input {
  flex: 1;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--card);
  color: var(--text);
  font-size: 12px;
  font-family: inherit;
}
.note-form-row input:focus {
  outline: none;
  border-color: var(--focus);
}
.notes-empty {
  font-size: 12px;
  font-style: italic;
  color: var(--muted);
  opacity: 0.6;
  padding: 8px 0;
}

.roadmap-card-image {
  width: 100%;
  height: 80px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 8px;
}

.prompt-ticket-thumb {
  width: 100%;
  height: 60px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 6px;
}

/* --- Tracker View Toggle --- */
.tracker-view-toggle {
  display: flex;
  gap: 2px;
  background: color-mix(in srgb, var(--text) 5%, transparent);
  border-radius: 8px;
  padding: 3px;
}

.tracker-view-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 28px;
  border: none;
  border-radius: 6px;
  background: transparent;
  color: var(--muted);
  cursor: pointer;
  transition: all 150ms ease;
}

.tracker-view-btn:hover { color: var(--text); background: color-mix(in srgb, var(--text) 5%, transparent); }

.tracker-view-btn.active {
  background: var(--panel2);
  color: var(--text);
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.tracker-view-btn svg { width: 16px; height: 16px; }

/* --- Netflix Shelf Feed --- */
.nf-feed {
  display: flex;
  flex-direction: column;
  gap: 28px;
  padding-top: 8px;
}

.nf-shelf { display: flex; flex-direction: column; gap: 10px; }

.nf-shelf-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 2px;
}

.nf-shelf-title {
  font-size: 15px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -0.01em;
}

.nf-shelf-count {
  font-size: 10px;
  font-weight: 600;
  color: var(--muted);
  background: color-mix(in srgb, var(--text) 6%, transparent);
  padding: 2px 8px;
  border-radius: 10px;
}

.nf-shelf-row {
  display: flex;
  gap: 14px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  padding: 6px 2px 12px;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: color-mix(in srgb, var(--border) 30%, transparent) transparent;
}

.nf-shelf-row::-webkit-scrollbar { height: 4px; }
.nf-shelf-row::-webkit-scrollbar-track { background: transparent; }
.nf-shelf-row::-webkit-scrollbar-thumb { background: color-mix(in srgb, var(--border) 30%, transparent); border-radius: 4px; }

/* --- Netflix Cards (Poster-Style) --- */
.nf-card {
  flex-shrink: 0;
  width: 180px;
  border-radius: 10px;
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
  overflow: hidden;
  cursor: pointer;
  transition: transform 200ms ease, box-shadow 200ms ease;
  scroll-snap-align: start;
  transform-style: preserve-3d;
  will-change: transform;
  position: relative;
}

.nf-card:hover {
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);
}

.nf-card-image {
  width: 100%;
  height: 140px;
  object-fit: cover;
  display: block;
}

.nf-card-placeholder {
  width: 100%;
  height: 140px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: color-mix(in srgb, var(--text) 4%, transparent);
  color: var(--muted);
}

.nf-card-placeholder svg { width: 36px; height: 36px; opacity: 0.3; }

.nf-card-overlay {
  position: relative;
}

.nf-card-overlay::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 40px;
  background: linear-gradient(to bottom, transparent, var(--panel2));
  pointer-events: none;
}

.nf-card-info {
  padding: 10px 12px 12px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.nf-card-title {
  font-size: 12px;
  font-weight: 600;
  color: var(--text);
  line-height: 1.3;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.nf-card-badges {
  display: flex;
  gap: 4px;
  flex-wrap: wrap;
}

.nf-card-area {
  font-size: 10px;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Priority glow */
.nf-glow-critical {
  border-color: color-mix(in srgb, #dc2626 50%, transparent);
  box-shadow: 0 0 12px color-mix(in srgb, #dc2626 18%, transparent);
}

.nf-glow-high {
  border-color: color-mix(in srgb, #ea580c 40%, transparent);
  box-shadow: 0 0 10px color-mix(in srgb, #ea580c 14%, transparent);
}

/* Hero shelf (larger cards) */
.nf-shelf-hero .nf-card { width: 220px; }
.nf-shelf-hero .nf-card-image,
.nf-shelf-hero .nf-card-placeholder { height: 170px; }

/* Done shelf (muted) */
.nf-shelf-done .nf-card { opacity: 0.5; }
.nf-shelf-done .nf-card:hover { opacity: 0.8; }

/* --- Simplified List View --- */
.simple-list {
  display: flex;
  flex-direction: column;
  gap: 1px;
  border-radius: 10px;
  overflow: hidden;
  background: color-mix(in srgb, var(--border) 8%, transparent);
  margin-top: 8px;
}

.simple-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 14px;
  background: var(--panel2);
  cursor: pointer;
  transition: background 120ms ease;
}

.simple-row:hover { background: color-mix(in srgb, var(--focus) 4%, var(--panel2)); }

.simple-priority {
  width: 3px;
  height: 22px;
  border-radius: 2px;
  flex-shrink: 0;
}

.simple-priority.p-critical { background: #dc2626; }
.simple-priority.p-high { background: #ea580c; }
.simple-priority.p-medium { background: var(--runRunning); }
.simple-priority.p-low { background: color-mix(in srgb, var(--muted) 40%, transparent); }

.simple-title {
  flex: 1;
  font-size: 12px;
  font-weight: 500;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  min-width: 0;
}

.simple-status {
  font-size: 9px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  padding: 2px 8px;
  border-radius: 4px;
  flex-shrink: 0;
}

.simple-status-open { color: var(--focus); background: color-mix(in srgb, var(--focus) 10%, transparent); }
.simple-status-progress { color: #e4a321; background: color-mix(in srgb, #e4a321 10%, transparent); }
.simple-status-review { color: #a78bfa; background: color-mix(in srgb, #a78bfa 10%, transparent); }
.simple-status-done { color: #34d399; background: color-mix(in srgb, #34d399 10%, transparent); }

.simple-done { opacity: 0.4; }
.simple-done .simple-title { text-decoration: line-through; }

/* --- Prompt Lab --- */
.prompt-layout {
  display: grid;
  grid-template-columns: 340px 1fr;
  gap: 20px;
  height: calc(100vh - 140px);
}

.prompt-sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  overflow-y: auto;
}

.prompt-ticket-card {
  padding: 12px;
  border: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  border-radius: 8px;
  background: var(--panel2);
  cursor: pointer;
  transition: all 150ms ease;
}

.prompt-ticket-card:hover {
  border-color: color-mix(in srgb, var(--focus) 30%, transparent);
}

.prompt-ticket-card.selected {
  border-color: var(--focus);
  background: color-mix(in srgb, var(--focus) 5%, transparent);
}

.prompt-ticket-name {
  font-size: 12px;
  font-weight: 500;
  margin-bottom: 4px;
}

.prompt-ticket-desc {
  font-size: 11px;
  color: var(--muted);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.prompt-main {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.prompt-output {
  flex: 1;
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  border-radius: 10px;
  padding: 20px;
  overflow-y: auto;
  font-family: ui-monospace, SFMono-Regular, monospace;
  font-size: 12px;
  line-height: 1.6;
  white-space: pre-wrap;
  color: var(--text);
  position: relative;
}

.prompt-output-empty {
  color: var(--muted);
  opacity: 0.5;
  font-family: inherit;
  font-style: italic;
}

.prompt-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.prompt-context-chips {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  flex: 1;
}

.context-chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 8px;
  font-size: 10px;
  font-weight: 500;
  background: color-mix(in srgb, var(--focus) 10%, transparent);
  color: var(--focus);
  border-radius: 4px;
  cursor: pointer;
  transition: all 150ms ease;
}

.context-chip:hover { background: color-mix(in srgb, var(--focus) 18%, transparent); }
.context-chip.active { background: var(--focus); color: var(--accentText); }

/* --- AI Loading State --- */
.prompt-loading {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  padding: 40px 20px;
  color: var(--muted);
  font-size: 13px;
}

.prompt-loading .spinner {
  width: 18px;
  height: 18px;
  border: 2px solid color-mix(in srgb, var(--focus) 20%, transparent);
  border-top-color: var(--focus);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }

.prompt-provider-select,
.prompt-model-select {
  padding: 5px 8px;
  font-size: 11px;
  color: var(--text);
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
  border-radius: 6px;
  outline: none;
  cursor: pointer;
  font-family: inherit;
}

.prompt-provider-select:focus,
.prompt-model-select:focus { border-color: var(--focus); }

.settings-modal-section {
  margin-bottom: 20px;
}

.settings-modal-section:last-child { margin-bottom: 0; }

.settings-modal-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--muted);
  margin-bottom: 8px;
}

.settings-modal-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

.settings-modal-row input {
  flex: 1;
  min-width: 0;
  padding: 7px 10px;
  font-size: 12px;
  font-family: ui-monospace, SFMono-Regular, monospace;
  color: var(--text);
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
  border-radius: 6px;
  outline: none;
}

.settings-modal-row input:focus { border-color: var(--focus); }

.settings-modal-hint {
  font-family: ui-monospace, SFMono-Regular, monospace;
  font-size: 12px;
  letter-spacing: 0.05em;
  color: var(--text);
}

.settings-modal-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: var(--muted);
}

.settings-modal-status .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--runPassed);
}

.settings-modal-status .dot.inactive {
  background: color-mix(in srgb, var(--muted) 30%, transparent);
}

.prompt-ai-output {
  flex: 1;
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  border-radius: 10px;
  padding: 20px;
  overflow-y: auto;
  font-size: 13px;
  line-height: 1.7;
  color: var(--text);
}

.prompt-ai-output h3 { font-size: 13px; font-weight: 600; margin: 16px 0 6px; color: var(--text); }
.prompt-ai-output h3:first-child { margin-top: 0; }
.prompt-ai-output p { margin: 0 0 10px; }
.prompt-ai-output ul, .prompt-ai-output ol { margin: 0 0 10px; padding-left: 20px; }
.prompt-ai-output li { margin-bottom: 4px; }
.prompt-ai-output strong { color: var(--text); }

/* --- Knowledge Base --- */
.kb-layout {
  display: grid;
  grid-template-columns: 240px 1fr;
  gap: 20px;
  height: calc(100vh - 140px);
}

.kb-nav {
  display: flex;
  flex-direction: column;
  gap: 2px;
  overflow-y: auto;
}

.kb-nav-item {
  padding: 8px 12px;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  border-radius: 6px;
  cursor: pointer;
  transition: all 150ms ease;
  border: none;
  background: transparent;
  text-align: left;
  width: 100%;
}

.kb-nav-item:hover {
  color: var(--text);
  background: color-mix(in srgb, var(--text) 5%, transparent);
}

.kb-nav-item.active {
  color: var(--focus);
  background: color-mix(in srgb, var(--focus) 10%, transparent);
}

.kb-content {
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  border-radius: 10px;
  padding: 28px;
  overflow-y: auto;
}

.kb-content h2 {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 16px;
  letter-spacing: -0.01em;
}

.kb-content h3 {
  font-size: 14px;
  font-weight: 600;
  margin: 20px 0 8px;
  color: var(--focus);
}

.kb-content p {
  font-size: 13px;
  line-height: 1.7;
  color: var(--muted);
  margin-bottom: 12px;
}

.kb-content code {
  font-family: ui-monospace, SFMono-Regular, monospace;
  font-size: 12px;
  background: color-mix(in srgb, var(--text) 5%, transparent);
  padding: 1px 5px;
  border-radius: 3px;
}

.kb-content pre {
  background: color-mix(in srgb, var(--text) 4%, transparent);
  border: 1px solid color-mix(in srgb, var(--border) 6%, transparent);
  border-radius: 6px;
  padding: 14px;
  overflow-x: auto;
  margin-bottom: 16px;
}

.kb-content pre code {
  background: transparent;
  padding: 0;
  font-size: 11px;
  line-height: 1.5;
}

.kb-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 16px;
  font-size: 12px;
}

.kb-table th {
  text-align: left;
  padding: 8px 12px;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  border-bottom: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
}

.kb-table td {
  padding: 8px 12px;
  border-bottom: 1px solid color-mix(in srgb, var(--border) 5%, transparent);
  color: var(--text);
}

.kb-table tr:hover td {
  background: color-mix(in srgb, var(--text) 2%, transparent);
}

/* --- Roadmap --- */
.roadmap-cols {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  height: calc(100vh - 140px);
}

.roadmap-col {
  display: flex;
  flex-direction: column;
  background: var(--panel);
  border: 1px solid color-mix(in srgb, var(--border) 6%, transparent);
  border-radius: 10px;
  overflow: hidden;
}

.roadmap-col-header {
  padding: 14px 16px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  border-bottom: 1px solid color-mix(in srgb, var(--border) 6%, transparent);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.roadmap-count {
  font-size: 10px;
  font-weight: 600;
  background: color-mix(in srgb, var(--text) 8%, transparent);
  padding: 1px 6px;
  border-radius: 8px;
}

.roadmap-cards {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.roadmap-card {
  background: var(--panel2);
  border: 1px solid color-mix(in srgb, var(--border) 6%, transparent);
  border-radius: 8px;
  padding: 12px;
  cursor: grab;
  transition: border-color 150ms ease, box-shadow 150ms ease;
  transform-style: preserve-3d;
  will-change: transform;
}

.roadmap-card:active { cursor: grabbing; }

.roadmap-card:hover {
  border-color: color-mix(in srgb, var(--focus) 30%, transparent);
  box-shadow: 0 4px 12px color-mix(in srgb, var(--text) 8%, transparent);
}

.roadmap-card.dragging {
  opacity: 0.4;
  transform: scale(0.96) !important;
}

.roadmap-cards.drag-over {
  background: color-mix(in srgb, var(--focus) 6%, transparent);
  border-radius: 0 0 10px 10px;
}

.roadmap-cards .drop-indicator {
  height: 2px;
  background: var(--focus);
  border-radius: 1px;
  margin: 2px 0;
  transition: opacity 100ms ease;
}

.roadmap-card-title {
  font-size: 12px;
  font-weight: 500;
  margin-bottom: 6px;
}

.roadmap-card-meta {
  display: flex;
  align-items: center;
  gap: 6px;
}

/* --- Copy toast --- */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--accentBg);
  color: var(--accentText);
  padding: 8px 20px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 500;
  z-index: 20000;
  transition: transform 250ms ease;
  pointer-events: none;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

.toast.visible { transform: translateX(-50%) translateY(0); }

/* --- Empty state --- */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 48px 24px;
  text-align: center;
}

.empty-state-icon {
  color: var(--muted);
  opacity: 0.25;
  margin-bottom: 12px;
}

.empty-state-title {
  font-size: 14px;
  font-weight: 500;
  color: var(--muted);
  margin-bottom: 4px;
}

.empty-state-sub {
  font-size: 12px;
  color: var(--muted);
  opacity: 0.6;
}

/* --- Activity Feed --- */
.activity-item {
  display: flex;
  gap: 10px;
  padding: 10px 0;
  border-bottom: 1px solid color-mix(in srgb, var(--border) 5%, transparent);
}

.activity-item:last-child { border-bottom: none; }

.activity-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  margin-top: 4px;
  flex-shrink: 0;
}

.activity-dot.dot-create { background: var(--runPassed); }
.activity-dot.dot-update { background: var(--runRunning); }
.activity-dot.dot-complete { background: var(--focus); }
.activity-dot.dot-delete { background: var(--runFailed); }

.activity-text {
  font-size: 12px;
  color: var(--text);
  line-height: 1.4;
}

.activity-time {
  font-size: 10px;
  color: var(--muted);
  opacity: 0.6;
  margin-top: 2px;
}

/* mobile-menu-btn removed — logo toggles nav on mobile */

/* --- Responsive: Tablet (≤ 900px) --- */
@media (max-width: 900px) {
  .prompt-layout { grid-template-columns: 1fr; height: auto; }
  .prompt-sidebar { max-height: 200px; overflow-y: auto; }
  .kb-layout { grid-template-columns: 1fr; height: auto; }
  .kb-nav { flex-direction: row; flex-wrap: wrap; }
  .kb-content { max-height: none; }
  .roadmap-cols { grid-template-columns: repeat(2, 1fr); height: auto; min-height: calc(100vh - 140px); }
  .dash-layout { grid-template-columns: 1fr; }
  .dash-two-col { grid-template-columns: 1fr; }
  .health-sidebar {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 6px;
    position: static;
    padding-bottom: 16px;
    border-bottom: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
    margin-bottom: 8px;
  }
  .health-sidebar-title { grid-column: 1 / -1; padding: 0 0 6px; }
  .health-row { padding: 6px 10px; border-radius: 8px; background: color-mix(in srgb, var(--text) 3%, transparent); }
  .detail-panel { width: 400px; }

  /* Netflix tracker — tablet */
  .nf-shelf-hero .nf-card { width: 200px; }
  .nf-shelf-hero .nf-card-image,
  .nf-shelf-hero .nf-card-placeholder { height: 150px; }
  .nf-card { width: 160px; }
  .nf-card-image, .nf-card-placeholder { height: 120px; }
}

/* --- Responsive: Mobile (≤ 640px) --- */
@media (max-width: 640px) {
  /* Shell & nav */
  .shell-header {
    padding: 0 12px;
    height: 48px;
    position: relative;
  }

  .shell-nav {
    display: none;
    position: absolute;
    top: 48px;
    left: 0;
    right: 0;
    background: var(--panel);
    border-bottom: 1px solid color-mix(in srgb, var(--border) 12%, transparent);
    flex-direction: column;
    z-index: 200;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  }

  .shell-nav.open { display: flex; }

  .shell-nav-btn {
    height: 48px;
    padding: 0 20px;
    font-size: 13px;
    justify-content: flex-start;
    border-bottom: none;
    border-left: 3px solid transparent;
  }

  .shell-nav-btn.active {
    border-bottom: none;
    border-left-color: var(--focus);
    background: color-mix(in srgb, var(--focus) 5%, transparent);
  }

  .shell-logo { cursor: pointer; }
  .shell-logo:active { color: var(--focus); }

  .shell-header-right { gap: 6px; }
  .theme-select { font-size: 10px; padding: 3px 6px; }

  /* Pages */
  .page {
    padding: 16px 14px;
    -webkit-overflow-scrolling: touch;
    overflow-x: hidden;
  }

  .page-title { font-size: 18px; }
  .page-subtitle { font-size: 12px; margin-bottom: 16px; }

  /* Dashboard — completely flatten for mobile */
  .dash-layout {
    display: flex;
    flex-direction: column;
    gap: 0;
    width: 100%;
    max-width: 100%;
  }
  .dash-layout > div { width: 100%; min-width: 0; max-width: 100%; }

  /* Health: simple vertical list, no grid */
  .health-sidebar {
    display: flex;
    flex-direction: column;
    gap: 0;
    position: static;
    padding: 0 0 12px;
    margin-bottom: 12px;
    border-bottom: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
  }
  .health-sidebar-title { padding: 0 0 8px; }
  .health-row {
    padding: 8px 4px;
    border-radius: 0;
    background: none;
    border-bottom: 1px solid color-mix(in srgb, var(--border) 4%, transparent);
    gap: 8px;
  }
  .health-row:last-child { border-bottom: none; }
  .health-row-label { font-size: 12px; flex: 1; min-width: 0; }
  .health-dot { width: 8px; height: 8px; }
  .health-row-count { font-size: 11px; }

  /* Stats: 2-col grid, no auto-fit guessing */
  .stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 16px;
  }
  .stat-card { padding: 14px 12px; }
  .stat-value { font-size: 22px; }
  .stat-label { font-size: 9px; }
  .stat-sub { display: none; }

  /* Recent panels — full width stack */
  .dash-two-col {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .dash-two-col > div { width: 100%; min-width: 0; }
  .dash-two-col .card {
    max-height: 240px;
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* Force all activity items to not overflow */
  .activity-item {
    min-width: 0;
    overflow: hidden;
  }
  .activity-item > div { min-width: 0; overflow: hidden; }
  .activity-item .badge { flex-shrink: 0; font-size: 8px; padding: 2px 6px; }
  .activity-text {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: 11px;
  }
  .activity-time { font-size: 9px; word-break: break-all; }

  .detail-fields-grid { grid-template-columns: 1fr; }

  /* Tracker */
  .tracker-toolbar { gap: 6px; }
  .tracker-search { min-width: 0; width: 100%; flex-basis: 100%; }
  .tracker-filter { flex: 1; min-width: 0; font-size: 10px; padding: 8px 24px 8px 8px; }
  .ticket-row { padding: 12px; gap: 10px; }
  .ticket-meta { flex-wrap: wrap; gap: 4px; }
  .ticket-actions { opacity: 1; }  /* Always show on mobile — no hover */
  .ticket-title { font-size: 13px; white-space: normal; }

  /* Modal */
  .modal {
    width: 100%;
    max-width: 100vw;
    max-height: 100vh;
    border-radius: 0;
    height: 100%;
  }
  .modal-overlay.open { align-items: stretch; }
  .modal-header { padding: 14px 16px; }
  .modal-body { padding: 16px; gap: 14px; }
  .modal-footer { padding: 12px 16px; }
  .form-row { flex-direction: column; gap: 14px; }

  /* Detail panel — full screen on mobile */
  .detail-panel {
    width: 100%;
    max-width: 100%;
    padding: 20px 16px;
  }
  .detail-actions { flex-wrap: wrap; }
  .detail-actions .btn { flex: 1; min-width: 0; justify-content: center; font-size: 11px; }

  /* Prompt Lab */
  .prompt-layout { grid-template-columns: 1fr; gap: 16px; height: auto; }
  .prompt-sidebar { max-height: 180px; overflow-y: auto; }
  .prompt-controls { flex-wrap: wrap; gap: 6px; }
  .prompt-type-tabs { flex-wrap: wrap; }
  .prompt-type-tab { font-size: 10px; padding: 5px 10px; }
  .prompt-output { font-size: 11px; padding: 14px; }

  /* Knowledge Base */
  .kb-layout { grid-template-columns: 1fr; gap: 12px; height: auto; }
  .kb-nav {
    flex-direction: row;
    flex-wrap: wrap;
    gap: 4px;
    overflow-y: visible;
  }
  .kb-nav-item { padding: 6px 10px; font-size: 11px; flex-shrink: 0; }
  .kb-content { padding: 16px; }
  .kb-content h2 { font-size: 16px; }
  .kb-content pre { font-size: 10px; padding: 10px; }
  .kb-table th, .kb-table td { padding: 6px 8px; font-size: 11px; }

  /* Roadmap */
  .roadmap-cols { grid-template-columns: 1fr; height: auto; gap: 10px; }
  .roadmap-col { border-radius: 8px; }
  .roadmap-cards { max-height: 300px; }
  .roadmap-card { padding: 10px; }
  .roadmap-card-title { font-size: 12px; }

  /* Section title */
  .section-title { font-size: 11px; margin-bottom: 8px; }

  /* Toast */
  .toast { bottom: 16px; font-size: 12px; padding: 8px 16px; }

  /* Inputs — larger touch targets */
  .input, .textarea, .select { padding: 10px 12px; font-size: 14px; }
  .btn { padding: 10px 16px; font-size: 13px; }
  .btn-sm { padding: 7px 12px; font-size: 11px; }
  .btn-icon { padding: 8px; }
  .btn-icon svg { width: 18px; height: 18px; }

  /* Netflix tracker — mobile */
  .nf-shelf-hero .nf-card { width: 160px; }
  .nf-shelf-hero .nf-card-image,
  .nf-shelf-hero .nf-card-placeholder { height: 120px; }
  .nf-card { width: 140px; }
  .nf-card-image, .nf-card-placeholder { height: 100px; }
  .nf-card-title { font-size: 11px; }
  .nf-shelf-title { font-size: 13px; }
  .nf-feed { gap: 20px; }
}

/* --- Responsive: Small phones (≤ 380px) --- */
@media (max-width: 380px) {
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .stat-card { padding: 10px 8px; }
  .stat-value { font-size: 18px; }
  .health-row-label { font-size: 11px; }
  .badge { font-size: 9px; padding: 2px 6px; }
  .tracker-filter { font-size: 9px; }

  /* Netflix tracker — small phones */
  .nf-shelf-hero .nf-card { width: 140px; }
  .nf-shelf-hero .nf-card-image,
  .nf-shelf-hero .nf-card-placeholder { height: 90px; }
  .nf-card { width: 130px; }
  .nf-card-image, .nf-card-placeholder { height: 90px; }
}

/* --- Safe area insets (notch/home bar) --- */
@supports (padding: max(0px)) {
  .shell-header {
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
  }
  .page {
    padding-left: max(14px, env(safe-area-inset-left));
    padding-right: max(14px, env(safe-area-inset-right));
    padding-bottom: max(16px, env(safe-area-inset-bottom));
  }
  .modal-body, .modal-footer {
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
  }
  .toast {
    bottom: max(16px, env(safe-area-inset-bottom));
  }
}

/* --- Prompt type selector --- */
.prompt-type-tabs {
  display: flex;
  gap: 2px;
  background: color-mix(in srgb, var(--text) 4%, transparent);
  border-radius: 8px;
  padding: 3px;
}

.prompt-type-tab {
  padding: 5px 12px;
  font-size: 11px;
  font-weight: 500;
  color: var(--muted);
  background: transparent;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 150ms ease;
}

.prompt-type-tab:hover { color: var(--text); }
.prompt-type-tab.active {
  color: var(--text);
  background: var(--panel2);
  box-shadow: 0 1px 3px color-mix(in srgb, var(--text) 8%, transparent);
}

/* --- Detail view overlay --- */
.detail-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 9000;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}

.detail-overlay.open { display: flex; justify-content: flex-end; }

.detail-panel {
  width: 520px;
  max-width: 95vw;
  background: var(--panel);
  border-left: 1px solid color-mix(in srgb, var(--border) 10%, transparent);
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  animation: slideIn 200ms ease;
}

@keyframes slideIn {
  from { transform: translateX(100%); }
  to { transform: translateX(0); }
}

.detail-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}

.detail-title-group { flex: 1; }

.detail-title {
  font-size: 16px;
  font-weight: 600;
  letter-spacing: -0.01em;
  margin-bottom: 8px;
}

.detail-badges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.detail-section-title {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
  margin-bottom: 8px;
}

.detail-desc {
  font-size: 13px;
  line-height: 1.6;
  color: var(--muted);
}

.detail-field {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.detail-field-label {
  font-size: 10px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
}

.detail-field-value {
  font-size: 13px;
  color: var(--text);
}

.detail-actions {
  display: flex;
  gap: 8px;
  padding-top: 12px;
  border-top: 1px solid color-mix(in srgb, var(--border) 8%, transparent);
}

/* --- Dashboard two-column panels --- */
.dash-two-col {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-top: 20px;
  min-width: 0;
}
.dash-two-col > div { min-width: 0; }

/* --- Detail fields grid --- */
.detail-fields-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
}

/* --- System Health Grid --- */
/* --- Dashboard layout with health sidebar --- */
.dash-layout {
  display: grid;
  grid-template-columns: 160px 1fr;
  gap: 24px;
  align-items: start;
}

.health-sidebar {
  display: flex;
  flex-direction: column;
  gap: 2px;
  position: sticky;
  top: 0;
}

.health-sidebar-title {
  font-size: 9px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
  padding: 0 8px 6px;
}

.health-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 8px;
  border-radius: 6px;
  cursor: pointer;
  transition: background 120ms ease;
}

.health-row:hover {
  background: color-mix(in srgb, var(--focus) 6%, transparent);
}

.health-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  flex-shrink: 0;
}

.health-dot.h-healthy {
  background: var(--runPassed);
  box-shadow: 0 0 4px color-mix(in srgb, var(--runPassed) 30%, transparent);
}

.health-dot.h-degraded {
  background: var(--runRunning);
  box-shadow: 0 0 5px color-mix(in srgb, var(--runRunning) 35%, transparent);
  animation: healthPulse 2s ease infinite;
}

.health-dot.h-outage {
  background: var(--runFailed);
  box-shadow: 0 0 6px color-mix(in srgb, var(--runFailed) 45%, transparent);
  animation: healthPulse 1.2s ease infinite;
}

@keyframes healthPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.health-row-label {
  font-size: 11px;
  color: var(--text);
  flex: 1;
  min-width: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.health-row-count {
  font-size: 9px;
  font-weight: 600;
  min-width: 14px;
  text-align: center;
  padding: 0 4px;
  border-radius: 6px;
  line-height: 16px;
  flex-shrink: 0;
}

.health-row-count.hc-ok {
  color: var(--runPassed);
}

.health-row-count.hc-warn {
  background: color-mix(in srgb, var(--runRunning) 12%, transparent);
  color: var(--runRunning);
}

.health-row-count.hc-crit {
  background: color-mix(in srgb, var(--runFailed) 12%, transparent);
  color: var(--runFailed);
}

/* --- Area badge --- */
.badge-area {
  background: color-mix(in srgb, var(--text) 6%, transparent);
  color: var(--muted);
  font-size: 10px;
  font-weight: 500;
  padding: 2px 7px;
  border-radius: 4px;
  text-transform: none;
  letter-spacing: 0;
}

/* --- Sub-area label --- */
.sub-area-label {
  font-size: 10px;
  color: var(--muted);
  opacity: 0.7;
  font-style: italic;
}
</style>
</head>
<body>
<div class="shell">
  <!-- Header -->
  <header class="shell-header">
    <div class="shell-header-left">
      <button class="shell-logo" id="shell-logo" aria-label="Menu">
        <svg viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
          <rect x="1.5" y="1.5" width="13.67" height="6.33" rx="1.5"/>
          <rect x="16.17" y="1.5" width="6.33" height="13.67" rx="1.5"/>
          <rect x="1.5" y="8.83" width="6.33" height="13.67" rx="1.5"/>
          <rect x="8.83" y="8.83" width="6.33" height="6.33" rx="1.5"/>
          <rect x="8.83" y="16.17" width="6.33" height="6.33" rx="1.5"/>
          <rect x="16.17" y="16.17" width="6.33" height="6.33" rx="1.5"/>
        </svg>
      </button>
      <nav class="shell-nav" id="shell-nav">
        <button class="shell-nav-btn active" data-page="dashboard">Dashboard</button>
        <button class="shell-nav-btn" data-page="tracker">Tracker</button>
        <button class="shell-nav-btn" data-page="prompts">Prompts</button>
        <button class="shell-nav-btn" data-page="kb">KB</button>
        <button class="shell-nav-btn" data-page="roadmap">Roadmap</button>
      </nav>
    </div>
    <div class="shell-header-right">
      <select class="theme-select" id="theme-select">
        <option value="marshmallow">Marshmallow</option>
        <option value="mocha">Mocha</option>
        <option value="disco">Disco</option>
        <option value="ronswanson">Ron Swanson</option>
        <option value="gringo">Gringo</option>
        <option value="matrix">Matrix</option>
      </select>
      <button class="btn-icon" onclick="openAppSettings()" title="Settings" style="padding:6px;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="16" height="16"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
    </div>
  </header>

  <!-- Pages -->
  <div class="main-content">

    <!-- Dashboard -->
    <div class="page active" id="page-dashboard"></div>

    <!-- Tracker -->
    <div class="page" id="page-tracker"></div>

    <!-- Prompt Lab -->
    <div class="page" id="page-prompts"></div>

    <!-- Knowledge Base -->
    <div class="page" id="page-kb"></div>

    <!-- Roadmap -->
    <div class="page" id="page-roadmap"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal"></div>
</div>

<!-- Detail Panel -->
<div class="detail-overlay" id="detail-overlay">
  <div class="detail-panel" id="detail-panel"></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// BPM (BentoBase Performance Manager) — Application Logic
// ============================================================

// --- Data Layer (SQLite-backed via server API) ---
const API_BASE = window.location.origin;
const JSON_HEADERS = { "Content-Type": "application/json" };
const STORAGE_KEY = "bentobase_portal"; // legacy key for migration

async function loadDataFromServer() {
  try {
    const res = await fetch(`${API_BASE}/api/data`);
    if (res.ok) return await res.json();
  } catch (e) {
    console.warn("[BPM] Server fetch failed, falling back to localStorage:", e.message);
  }
  // Fallback: if server is unreachable, try localStorage
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch (e) {}
  return { tickets: [], activity: [], kbNotes: {} };
}

// --- Granular API helpers ---
function apiCreateTicket(ticket, activityEntry) {
  const payload = { ...ticket };
  if (activityEntry) payload._activity = activityEntry;
  fetch(`${API_BASE}/api/tickets`, {
    method: "POST", headers: JSON_HEADERS, body: JSON.stringify(payload),
  }).catch(err => console.warn("[BPM] Create failed:", err.message));
}

function apiUpdateTicket(id, fields, activityEntry) {
  const payload = { ...fields };
  if (activityEntry) payload._activity = activityEntry;
  fetch(`${API_BASE}/api/tickets/${encodeURIComponent(id)}`, {
    method: "PUT", headers: JSON_HEADERS, body: JSON.stringify(payload),
  }).catch(err => console.warn("[BPM] Update failed:", err.message));
}

function apiDeleteTicket(id, activityEntry) {
  const payload = activityEntry ? { _activity: activityEntry } : {};
  fetch(`${API_BASE}/api/tickets/${encodeURIComponent(id)}`, {
    method: "DELETE", headers: JSON_HEADERS, body: JSON.stringify(payload),
  }).catch(err => console.warn("[BPM] Delete failed:", err.message));
}

// --- Notes API helpers ---
async function apiGetNotes(ticketId) {
  try {
    const res = await fetch(`${API_BASE}/api/tickets/${encodeURIComponent(ticketId)}/notes`);
    if (res.ok) return await res.json();
  } catch (e) { console.warn("[BPM] Fetch notes failed:", e.message); }
  return [];
}

async function apiCreateNote(ticketId, note) {
  try {
    const res = await fetch(`${API_BASE}/api/tickets/${encodeURIComponent(ticketId)}/notes`, {
      method: "POST", headers: JSON_HEADERS, body: JSON.stringify(note),
    });
    if (res.ok) return await res.json();
  } catch (e) { console.warn("[BPM] Create note failed:", e.message); }
  return null;
}

async function apiDeleteNote(ticketId, noteId) {
  try {
    await fetch(`${API_BASE}/api/tickets/${encodeURIComponent(ticketId)}/notes/${encodeURIComponent(noteId)}`, {
      method: "DELETE", headers: JSON_HEADERS,
    });
  } catch (err) { console.warn("[BPM] Delete note failed:", err.message); }
}

// Bulk sync fallback (used for migration)
function saveData(data) {
  fetch(`${API_BASE}/api/data`, {
    method: "PUT", headers: JSON_HEADERS, body: JSON.stringify(data),
  }).catch(err => console.warn("[BPM] Save failed:", err.message));
}

async function loadSettingsFromServer() {
  try {
    const res = await fetch(`${API_BASE}/api/settings`);
    if (res.ok) return await res.json();
  } catch (e) {}
  return { theme: "marshmallow" };
}

function saveSettings(settings) {
  fetch(`${API_BASE}/api/settings`, {
    method: "PUT", headers: JSON_HEADERS, body: JSON.stringify(settings),
  }).catch(err => console.warn("[BPM] Settings save failed:", err.message));
}

// --- Ticket Image Helpers ---
function apiRegenerateImage(id) {
  return fetch(`${API_BASE}/api/tickets/${encodeURIComponent(id)}/generate-image`, {
    method: "POST", headers: JSON_HEADERS,
  }).catch(err => console.warn("[BPM] Regenerate image failed:", err.message));
}

function pollForTicketImage(ticketId, maxAttempts = 25, intervalMs = 3000) {
  let attempts = 0;
  const poll = setInterval(async () => {
    attempts++;
    try {
      const res = await fetch(`${API_BASE}/api/tickets/${encodeURIComponent(ticketId)}/image`);
      if (res.ok) {
        const data = await res.json();
        if (data.image) {
          clearInterval(poll);
          const t = DATA.tickets.find(x => x.id === ticketId);
          if (t) {
            t.image = data.image;
            renderCurrentPage();
          }
        }
      }
    } catch (e) { /* ignore */ }
    if (attempts >= maxAttempts) clearInterval(poll);
  }, intervalMs);
}

// Migrate localStorage data to server on first load
async function migrateLocalStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const localData = JSON.parse(raw);
    if (!localData.tickets || localData.tickets.length === 0) return;

    // Check if server already has data
    const res = await fetch(`${API_BASE}/api/data`);
    if (res.ok) {
      const serverData = await res.json();
      if (serverData.tickets && serverData.tickets.length > 0) return;
    }

    // Push local data to server via bulk sync
    await fetch(`${API_BASE}/api/data`, {
      method: "PUT", headers: JSON_HEADERS, body: raw,
    });
    console.log("[BPM] Migrated localStorage data to server.");

    const savedTheme = localStorage.getItem("bb_portal_theme");
    if (savedTheme) saveSettings({ theme: savedTheme });

    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem("bb_portal_theme");
    console.log("[BPM] Cleared legacy localStorage entries.");
  } catch (e) {
    console.warn("[BPM] Migration failed:", e.message);
  }
}

let DATA = { tickets: [], activity: [], kbNotes: {} };

function genId() {
  return "BB-" + Math.random().toString(36).substring(2, 8).toUpperCase();
}

function now() { return new Date().toISOString(); }

function addActivity(action, ticketId, title) {
  DATA.activity.unshift({ action, ticketId, title, time: now() });
  if (DATA.activity.length > 100) DATA.activity.length = 100;
  // Activity is persisted via the ticket API calls (_activity field)
}

function formatTime(iso) {
  const d = new Date(iso);
  const diff = Date.now() - d;
  if (diff < 60000) return "just now";
  if (diff < 3600000) return Math.floor(diff / 60000) + "m ago";
  if (diff < 86400000) return Math.floor(diff / 3600000) + "h ago";
  if (diff < 604800000) return Math.floor(diff / 86400000) + "d ago";
  return d.toLocaleDateString();
}

function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
}

// --- App Areas ---
const APP_AREAS = {
  login:      { label: "Login Screen",  icon: '\u2022', subareas: ["PIN entry", "Authentication flow", "Session management", "Splash screen", "Error states", "Lockout logic"] },
  agents:     { label: "Agents",        icon: '\u2022', subareas: ["Agent editor", "Agent list", "Agent capabilities", "Agent classification", "Activity log", "Collaborators"] },
  flows:      { label: "Flows",         icon: '\u2022', subareas: ["Canvas", "Node palette", "Inspector", "Library tab", "Agents tab", "SubFlow navigation", "Edge connections", "Node execution", "Drag & drop"] },
  data:       { label: "Data",          icon: '\u2022', subareas: ["Connections", "Files", "Knowledge bases", "File upload", "Data preview"] },
  interfaces: { label: "Interfaces",    icon: '\u2022', subareas: ["Interface editor", "Layout", "Components", "Preview"] },
  community:  { label: "Community",     icon: '\u2022', subareas: ["Marketplace", "Discussion", "My Store", "Ratings", "Search & filter"] },
  showcase:   { label: "Showcase",      icon: '\u2022', subareas: ["App gallery", "Full-screen viewer", "Featured apps", "Categories"] },
  settings:   { label: "Settings",      icon: '\u2022', subareas: ["API providers", "Backend services", "MCP servers", "Account", "Theme"] },
  security:   { label: "App Security",  icon: '\u2022', subareas: ["Auth & identity", "Data encryption", "Input validation", "Permissions", "API keys & secrets", "CSP & sandboxing"] },
  structure:  { label: "App Structure", icon: '\u2022', subareas: ["Module layout", "State management", "Routing", "Build & packaging", "Electron shell", "File organization"] },
  ux:         { label: "UX & Design",   icon: '\u2022', subareas: ["Theming", "Typography", "Layout & spacing", "Responsive", "Accessibility", "Animations"] },
  perf:       { label: "Performance",   icon: '\u2022', subareas: ["Rendering", "Memory", "Load time", "Storage", "Large data sets"] },
  docs:       { label: "Documentation", icon: '\u2022', subareas: ["README", "Inline docs", "Knowledge base", "API reference", "Onboarding"] },
  portal:     { label: "Dev Dashboard", icon: '\u2022', subareas: ["Dashboard view", "Tracker", "Roadmap board", "Prompt Lab", "Knowledge Base", "Drag & drop", "3D tilt effects", "API & server", "SQLite storage", "Deployment"] },
};

const AREA_KEYS = Object.keys(APP_AREAS);

function getAreaLabel(key) { return APP_AREAS[key]?.label || key || ""; }
function getSubareas(areaKey) { return APP_AREAS[areaKey]?.subareas || []; }

function getAreaHealth(areaKey) {
  const areaTickets = DATA.tickets.filter(t => t.area === areaKey && t.status !== "done");
  const criticalAll = areaTickets.filter(t => t.priority === "critical").length;
  const highAll = areaTickets.filter(t => t.priority === "high").length;
  const openCount = areaTickets.length;
  if (criticalAll > 0) return { level: "outage", label: `${criticalAll} critical`, countClass: "hc-crit", count: openCount };
  if (highAll > 0) return { level: "degraded", label: `${highAll} high-priority`, countClass: "hc-warn", count: openCount };
  if (openCount > 0) return { level: "healthy", label: `${openCount} open`, countClass: "hc-ok", count: openCount };
  return { level: "healthy", label: "No issues", countClass: "hc-ok", count: 0 };
}

// --- Theme ---
const themeSelect = document.getElementById("theme-select");
themeSelect.addEventListener("change", () => {
  document.documentElement.setAttribute("data-theme", themeSelect.value);
  saveSettings({ theme: themeSelect.value });
});

// --- Navigation ---
let currentPage = "dashboard";
const shellNav = document.getElementById("shell-nav");
const shellLogo = document.getElementById("shell-logo");

// Logo toggles mobile nav menu
shellLogo.addEventListener("click", (e) => {
  e.stopPropagation();
  shellNav.classList.toggle("open");
});

// Close mobile menu when clicking outside
document.addEventListener("click", (e) => {
  if (!shellNav.contains(e.target) && !shellLogo.contains(e.target)) {
    shellNav.classList.remove("open");
  }
});

document.querySelectorAll(".shell-nav-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    currentPage = btn.dataset.page;
    document.querySelectorAll(".shell-nav-btn").forEach(b => b.classList.toggle("active", b === btn));
    document.querySelectorAll(".page").forEach(p => p.classList.toggle("active", p.id === "page-" + currentPage));
    shellNav.classList.remove("open"); // close mobile menu on navigate
    renderCurrentPage();
  });
});

function renderCurrentPage() {
  const renderers = {
    dashboard: renderDashboard,
    tracker: renderTracker,
    prompts: renderPromptLab,
    kb: renderKB,
    roadmap: renderRoadmap,
  };
  (renderers[currentPage] || (() => {}))();
}

// --- Modal ---
const modalOverlay = document.getElementById("modal-overlay");
const modalEl = document.getElementById("modal");

function openModal(html) {
  modalEl.innerHTML = html;
  modalOverlay.classList.add("open");
}

function closeModal() {
  modalOverlay.classList.remove("open");
}

modalOverlay.addEventListener("click", e => { if (e.target === modalOverlay) closeModal(); });

// --- Detail Panel ---
const detailOverlay = document.getElementById("detail-overlay");
const detailPanel = document.getElementById("detail-panel");

function openDetail(html) {
  detailPanel.innerHTML = html;
  detailOverlay.classList.add("open");
}

function closeDetail() {
  detailOverlay.classList.remove("open");
}

detailOverlay.addEventListener("click", e => { if (e.target === detailOverlay) closeDetail(); });

// --- Toast ---
const toastEl = document.getElementById("toast");
let toastTimer = null;

function showToast(msg) {
  clearTimeout(toastTimer);
  toastEl.textContent = msg;
  toastEl.classList.add("visible");
  toastTimer = setTimeout(() => toastEl.classList.remove("visible"), 2400);
}

// --- Copy to clipboard ---
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => showToast("Copied to clipboard"));
}

// === DASHBOARD ===
function renderDashboard() {
  const t = DATA.tickets;
  const open = t.filter(x => x.status === "open").length;
  const inProgress = t.filter(x => x.status === "progress").length;
  const review = t.filter(x => x.status === "review").length;
  const done = t.filter(x => x.status === "done").length;
  const bugs = t.filter(x => x.type === "bug" && x.status !== "done").length;
  const features = t.filter(x => x.type === "feature" && x.status !== "done").length;

  const recentActivity = DATA.activity.slice(0, 12);
  const recentTickets = [...t].sort((a, b) => (b.updatedAt || b.createdAt || "").localeCompare(a.updatedAt || a.createdAt || "")).slice(0, 5);

  const dotClass = { create: "dot-create", update: "dot-update", complete: "dot-complete", delete: "dot-delete", prompt: "dot-update" };

  // Health sidebar rows
  const healthRows = AREA_KEYS.map(key => {
    const h = getAreaHealth(key);
    const a = APP_AREAS[key];
    return `
      <div class="health-row" onclick="drillToArea('${key}')">
        <div class="health-dot h-${h.level}"></div>
        <span class="health-row-label">${esc(a.label)}</span>
        ${h.count > 0 ? `<span class="health-row-count ${h.countClass}">${h.count}</span>` : ""}
      </div>
    `;
  }).join("");

  document.getElementById("page-dashboard").innerHTML = `
    <div class="page-title">BPM Dashboard</div>
    <div class="page-subtitle">BentoBase Performance Management</div>

    <div class="dash-layout">
      <div class="health-sidebar">
        <div class="health-sidebar-title">System Health</div>
        ${healthRows}
      </div>

      <div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Open</div>
            <div class="stat-value">${open}</div>
            <div class="stat-sub">tickets awaiting work</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">In Progress</div>
            <div class="stat-value">${inProgress}</div>
            <div class="stat-sub">actively being worked</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">In Review</div>
            <div class="stat-value">${review}</div>
            <div class="stat-sub">awaiting validation</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Completed</div>
            <div class="stat-value">${done}</div>
            <div class="stat-sub">shipped and verified</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Open Bugs</div>
            <div class="stat-value" style="color:var(--runFailed)">${bugs}</div>
            <div class="stat-sub">requiring fixes</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Planned Features</div>
            <div class="stat-value" style="color:var(--focus)">${features}</div>
            <div class="stat-sub">in the pipeline</div>
          </div>
        </div>

        <div class="dash-two-col">
          <div>
            <div class="section-title">Recent Activity</div>
            <div class="card" style="padding:12px 16px;">
              ${recentActivity.length === 0 ? '<div class="empty-state"><div class="empty-state-sub">No activity yet. Create your first ticket to get started.</div></div>' :
                recentActivity.map(a => `
                  <div class="activity-item">
                    <div class="activity-dot ${dotClass[a.action] || "dot-update"}"></div>
                    <div>
                      <div class="activity-text">${esc(a.title)}</div>
                      <div class="activity-time">${formatTime(a.time)}${a.ticketId ? ` \u00b7 ${esc(a.ticketId)}` : ""}</div>
                    </div>
                  </div>
                `).join("")}
            </div>
          </div>
          <div>
            <div class="section-title">Recently Updated</div>
            <div class="card" style="padding:12px 16px;">
              ${recentTickets.length === 0 ? '<div class="empty-state"><div class="empty-state-sub">No tickets yet.</div></div>' :
                recentTickets.map(t => `
                  <div class="activity-item" style="cursor:pointer" onclick="openTicketDetail('${t.id}')">
                    <div class="ticket-priority p-${t.priority}" style="width:3px;height:20px;border-radius:2px;margin-top:2px;flex-shrink:0"></div>
                    ${t.image ? `<img style="width:24px;height:24px;border-radius:4px;object-fit:cover;flex-shrink:0" src="data:image/png;base64,${t.image}" alt="" loading="lazy" />` : ``}
                    <div style="flex:1;min-width:0">
                      <div class="activity-text" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title)}</div>
                      <div class="activity-time">${esc(t.id)} \u00b7 ${formatTime(t.updatedAt || t.createdAt)}${t.area ? ` \u00b7 ${getAreaLabel(t.area)}` : ""}</div>
                    </div>
                    <span class="badge badge-${t.status}">${t.status === "progress" ? "In Progress" : t.status}</span>
                  </div>
                `).join("")}
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

function drillToArea(areaKey) {
  trackerAreaFilter = areaKey;
  trackerSearch = "";
  trackerTypeFilter = "all";
  trackerStatusFilter = "all";
  trackerPriorityFilter = "all";
  currentPage = "tracker";
  document.querySelectorAll(".shell-nav-btn").forEach(b => b.classList.toggle("active", b.dataset.page === "tracker"));
  document.querySelectorAll(".page").forEach(p => p.classList.toggle("active", p.id === "page-tracker"));
  renderTracker();
}

function updateSubareaOptions(selectId, areaKey, currentValue) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  if (!areaKey) {
    sel.innerHTML = '<option value="">Select area first</option>';
    sel.disabled = true;
    return;
  }
  const subs = getSubareas(areaKey);
  sel.innerHTML = '<option value="">None</option>' + subs.map(s => `<option value="${s}"${s === currentValue ? " selected" : ""}>${s}</option>`).join("");
  sel.disabled = false;
}

// === TRACKER ===
let trackerSearch = "";
let trackerTypeFilter = "all";
let trackerStatusFilter = "all";
let trackerPriorityFilter = "all";
let trackerAreaFilter = "all";
let trackerView = "netflix"; // "netflix" | "simple"

function getFilteredTickets() {
  let list = [...DATA.tickets];
  if (trackerSearch) {
    const q = trackerSearch.toLowerCase();
    list = list.filter(t => t.title.toLowerCase().includes(q) || (t.description || "").toLowerCase().includes(q) || t.id.toLowerCase().includes(q) || getAreaLabel(t.area).toLowerCase().includes(q) || (t.subarea || "").toLowerCase().includes(q));
  }
  if (trackerTypeFilter !== "all") list = list.filter(t => t.type === trackerTypeFilter);
  if (trackerStatusFilter !== "all") list = list.filter(t => t.status === trackerStatusFilter);
  if (trackerPriorityFilter !== "all") list = list.filter(t => t.priority === trackerPriorityFilter);
  if (trackerAreaFilter !== "all") list = list.filter(t => t.area === trackerAreaFilter);

  // Sort: by priority weight then creation date
  const pw = { critical: 0, high: 1, medium: 2, low: 3 };
  const sw = { open: 0, progress: 1, review: 2, done: 3 };
  list.sort((a, b) => sw[a.status] - sw[b.status] || pw[a.priority] - pw[b.priority] || (b.createdAt || "").localeCompare(a.createdAt || ""));
  return list;
}

// --- Netflix shelf grouping ---
function getNetflixShelves(tickets) {
  const pw = { critical: 0, high: 1, medium: 2, low: 3 };
  const byPriorityDate = (a, b) => pw[a.priority] - pw[b.priority] || (b.createdAt || "").localeCompare(a.createdAt || "");

  // Hero shelf: critical/high non-done
  const heroIds = new Set();
  const hero = tickets.filter(t => (t.priority === "critical" || t.priority === "high") && t.status !== "done");
  hero.sort(byPriorityDate);
  hero.forEach(t => heroIds.add(t.id));

  // Status-based shelves (exclude hero tickets)
  const progress = tickets.filter(t => t.status === "progress" && !heroIds.has(t.id)).sort(byPriorityDate);
  const open = tickets.filter(t => t.status === "open" && !heroIds.has(t.id)).sort(byPriorityDate);
  const review = tickets.filter(t => t.status === "review" && !heroIds.has(t.id)).sort(byPriorityDate);

  // Done shelf: by updatedAt desc, capped at 10
  const done = tickets.filter(t => t.status === "done")
    .sort((a, b) => (b.updatedAt || "").localeCompare(a.updatedAt || ""))
    .slice(0, 10);

  const shelves = [];
  if (hero.length) shelves.push({ title: "Critical & High Priority", tickets: hero, cls: "nf-shelf-hero" });
  if (progress.length) shelves.push({ title: "In Progress", tickets: progress, cls: "" });
  if (open.length) shelves.push({ title: "Open Tickets", tickets: open, cls: "" });
  if (review.length) shelves.push({ title: "In Review", tickets: review, cls: "" });
  if (done.length) shelves.push({ title: "Recently Completed", tickets: done, cls: "nf-shelf-done" });
  return shelves;
}

// --- Netflix card renderer ---
function renderNfCard(t) {
  const glowCls = t.priority === "critical" ? " nf-glow-critical" : t.priority === "high" ? " nf-glow-high" : "";
  const statusLabel = { open: "Open", progress: "In Progress", review: "Review", done: "Done" };
  const imageHtml = t.image
    ? `<div class="nf-card-overlay"><img class="nf-card-image" src="data:image/png;base64,${t.image}" alt="" loading="lazy" /></div>`
    : `<div class="nf-card-overlay"><div class="nf-card-placeholder"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1"><rect x="3" y="3" width="18" height="18" rx="3"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div></div>`;
  return `
    <div class="nf-card${glowCls}" onclick="openTicketDetail('${t.id}')">
      ${imageHtml}
      <div class="nf-card-info">
        <div class="nf-card-title">${esc(t.title)}</div>
        <div class="nf-card-badges">
          <span class="badge badge-${t.type}">${esc(t.type)}</span>
          <span class="badge badge-${t.priority}">${esc(t.priority)}</span>
        </div>
        ${t.area ? `<div class="nf-card-area">${esc(getAreaLabel(t.area))}${t.subarea ? ` › ${esc(t.subarea)}` : ""}</div>` : ""}
      </div>
    </div>`;
}

// --- Netflix view renderer ---
function renderNetflixView(tickets) {
  const shelves = getNetflixShelves(tickets);
  if (shelves.length === 0) {
    return `
      <div class="empty-state">
        <div class="empty-state-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 12h6M12 9v6"/></svg></div>
        <div class="empty-state-title">No tickets${trackerSearch || trackerTypeFilter !== "all" || trackerStatusFilter !== "all" || trackerAreaFilter !== "all" ? " match your filters" : " yet"}</div>
        <div class="empty-state-sub">Create your first ticket to start tracking work.</div>
      </div>`;
  }
  return `<div class="nf-feed">${shelves.map(s => `
    <div class="nf-shelf ${s.cls}">
      <div class="nf-shelf-header">
        <div class="nf-shelf-title">${s.title}</div>
        <div class="nf-shelf-count">${s.tickets.length}</div>
      </div>
      <div class="nf-shelf-row">${s.tickets.map(renderNfCard).join("")}</div>
    </div>`).join("")}</div>`;
}

// --- Simplified view renderer ---
function renderSimpleView(tickets) {
  const statusLabel = { open: "Open", progress: "In Progress", review: "Review", done: "Done" };
  if (tickets.length === 0) {
    return `
      <div class="empty-state">
        <div class="empty-state-icon"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="3"/><path d="M9 12h6M12 9v6"/></svg></div>
        <div class="empty-state-title">No tickets${trackerSearch || trackerTypeFilter !== "all" || trackerStatusFilter !== "all" || trackerAreaFilter !== "all" ? " match your filters" : " yet"}</div>
        <div class="empty-state-sub">Create your first ticket to start tracking work.</div>
      </div>`;
  }
  return `<div class="simple-list">${tickets.map(t => `
    <div class="simple-row${t.status === "done" ? " simple-done" : ""}" onclick="openTicketDetail('${t.id}')">
      <div class="simple-priority p-${t.priority}"></div>
      <div class="simple-title">${esc(t.title)}</div>
      <span class="simple-status simple-status-${t.status}">${statusLabel[t.status] || t.status}</span>
    </div>`).join("")}</div>`;
}

// --- View toggle handler ---
function setTrackerView(view) {
  trackerView = view;
  renderTracker();
}

function renderTracker() {
  const tickets = getFilteredTickets();

  document.getElementById("page-tracker").innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="page-title">Tracker</div>
        <div class="tracker-view-toggle">
          <button class="tracker-view-btn${trackerView === "netflix" ? " active" : ""}" onclick="setTrackerView('netflix')" title="Card View">
            <svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg>
          </button>
          <button class="tracker-view-btn${trackerView === "simple" ? " active" : ""}" onclick="setTrackerView('simple')" title="List View">
            <svg viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="2" width="14" height="2.5" rx="1"/><rect x="1" y="6.75" width="14" height="2.5" rx="1"/><rect x="1" y="11.5" width="14" height="2.5" rx="1"/></svg>
          </button>
        </div>
      </div>
      <button class="btn btn-primary" onclick="openNewTicketModal()">+ New Ticket</button>
    </div>
    <div class="page-subtitle">Bugs, features, and enhancements &mdash; ${DATA.tickets.length} total</div>

    <div class="tracker-toolbar">
      <input class="tracker-search" type="text" placeholder="Search tickets\u2026" value="${esc(trackerSearch)}" id="tracker-search" />
      <select class="tracker-filter" id="tracker-type-filter">
        <option value="all">All types</option>
        <option value="bug"${trackerTypeFilter==="bug"?" selected":""}>Bugs</option>
        <option value="feature"${trackerTypeFilter==="feature"?" selected":""}>Features</option>
        <option value="enhancement"${trackerTypeFilter==="enhancement"?" selected":""}>Enhancements</option>
        <option value="refactor"${trackerTypeFilter==="refactor"?" selected":""}>Refactors</option>
        <option value="docs"${trackerTypeFilter==="docs"?" selected":""}>Docs</option>
      </select>
      <select class="tracker-filter" id="tracker-status-filter">
        <option value="all">All statuses</option>
        <option value="open"${trackerStatusFilter==="open"?" selected":""}>Open</option>
        <option value="progress"${trackerStatusFilter==="progress"?" selected":""}>In Progress</option>
        <option value="review"${trackerStatusFilter==="review"?" selected":""}>Review</option>
        <option value="done"${trackerStatusFilter==="done"?" selected":""}>Done</option>
      </select>
      <select class="tracker-filter" id="tracker-priority-filter">
        <option value="all">All priorities</option>
        <option value="critical"${trackerPriorityFilter==="critical"?" selected":""}>Critical</option>
        <option value="high"${trackerPriorityFilter==="high"?" selected":""}>High</option>
        <option value="medium"${trackerPriorityFilter==="medium"?" selected":""}>Medium</option>
        <option value="low"${trackerPriorityFilter==="low"?" selected":""}>Low</option>
      </select>
      <select class="tracker-filter" id="tracker-area-filter">
        <option value="all">All areas</option>
        ${AREA_KEYS.map(k => `<option value="${k}"${trackerAreaFilter===k?" selected":""}>${APP_AREAS[k].label}</option>`).join("")}
      </select>
    </div>

    <div id="tracker-content">
      ${trackerView === "netflix" ? renderNetflixView(tickets) : renderSimpleView(tickets)}
    </div>
  `;

  // Bind filter events
  document.getElementById("tracker-search")?.addEventListener("input", e => {
    trackerSearch = e.target.value;
    renderTracker();
    const el = document.getElementById("tracker-search");
    if (el) { el.focus(); el.selectionStart = el.selectionEnd = e.target.selectionStart; }
  });
  document.getElementById("tracker-type-filter")?.addEventListener("change", e => { trackerTypeFilter = e.target.value; renderTracker(); });
  document.getElementById("tracker-status-filter")?.addEventListener("change", e => { trackerStatusFilter = e.target.value; renderTracker(); });
  document.getElementById("tracker-priority-filter")?.addEventListener("change", e => { trackerPriorityFilter = e.target.value; renderTracker(); });
  document.getElementById("tracker-area-filter")?.addEventListener("change", e => { trackerAreaFilter = e.target.value; renderTracker(); });

  // Init 3D tilt for Netflix cards
  if (trackerView === "netflix") initTrackerTilt();
}

function cycleStatus(id) {
  const t = DATA.tickets.find(x => x.id === id);
  if (!t) return;
  const order = ["open", "progress", "review", "done"];
  const i = order.indexOf(t.status);
  t.status = order[(i + 1) % order.length];
  t.updatedAt = now();
  const act = { action: t.status === "done" ? "complete" : "update", ticketId: t.id, title: `${t.title} \u2192 ${t.status}`, time: now() };
  addActivity(act.action, act.ticketId, act.title);
  apiUpdateTicket(t.id, { status: t.status, updatedAt: t.updatedAt }, act);
  renderCurrentPage();
}

// --- Ticket Modal ---
function openNewTicketModal() {
  openModal(`
    <div class="modal-header">
      <div class="modal-title">New Ticket</div>
      <button class="btn-icon" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input class="input" id="m-title" placeholder="Short, descriptive title" autofocus />
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="textarea" id="m-desc" placeholder="What needs to happen? Include context, steps to reproduce (for bugs), or acceptance criteria."></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="select" id="m-type">
            <option value="bug">Bug</option>
            <option value="feature" selected>Feature</option>
            <option value="enhancement">Enhancement</option>
            <option value="refactor">Refactor</option>
            <option value="docs">Docs</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="select" id="m-priority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Area</label>
          <select class="select" id="m-area" onchange="updateSubareaOptions('m-subarea', this.value)">
            <option value="">None</option>
            ${AREA_KEYS.map(k => `<option value="${k}">${APP_AREAS[k].label}</option>`).join("")}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Sub-area</label>
          <select class="select" id="m-subarea" disabled>
            <option value="">Select area first</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Assignee</label>
          <input class="input" id="m-assignee" placeholder="(optional)" />
        </div>
        <div class="form-group">
          <label class="form-label">Files Affected</label>
          <input class="input" id="m-files" placeholder="e.g. src/ui/editor.js, src/app.css" />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitNewTicket()">Create Ticket</button>
    </div>
  `);
  setTimeout(() => document.getElementById("m-title")?.focus(), 50);
}

function submitNewTicket() {
  const title = document.getElementById("m-title")?.value.trim();
  if (!title) return;
  const ticket = {
    id: genId(),
    title,
    description: document.getElementById("m-desc")?.value.trim() || "",
    type: document.getElementById("m-type")?.value || "feature",
    priority: document.getElementById("m-priority")?.value || "medium",
    status: "open",
    area: document.getElementById("m-area")?.value || "",
    subarea: document.getElementById("m-subarea")?.value || "",
    assignee: document.getElementById("m-assignee")?.value.trim() || "",
    files: document.getElementById("m-files")?.value.trim() || "",
    createdAt: now(),
    updatedAt: now(),
  };
  DATA.tickets.push(ticket);
  const act = { action: "create", ticketId: ticket.id, title: `Created: ${ticket.title}`, time: now() };
  addActivity(act.action, act.ticketId, act.title);
  apiCreateTicket(ticket, act);
  pollForTicketImage(ticket.id);
  closeModal();
  renderCurrentPage();
}

function openEditTicketModal(id) {
  const t = DATA.tickets.find(x => x.id === id);
  if (!t) return;
  closeDetail();
  openModal(`
    <div class="modal-header">
      <div class="modal-title">Edit ${esc(t.id)}</div>
      <button class="btn-icon" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input class="input" id="m-title" value="${esc(t.title)}" />
      </div>
      <div class="form-group">
        <label class="form-label">Description</label>
        <textarea class="textarea" id="m-desc">${esc(t.description)}</textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Type</label>
          <select class="select" id="m-type">
            ${["bug","feature","enhancement","refactor","docs"].map(v => `<option value="${v}"${t.type===v?" selected":""}>${v}</option>`).join("")}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <select class="select" id="m-priority">
            ${["low","medium","high","critical"].map(v => `<option value="${v}"${t.priority===v?" selected":""}>${v}</option>`).join("")}
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="select" id="m-status">
            ${["open","progress","review","done"].map(v => `<option value="${v}"${t.status===v?" selected":""}>${v === "progress" ? "In Progress" : v}</option>`).join("")}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Assignee</label>
          <input class="input" id="m-assignee" value="${esc(t.assignee || "")}" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Area</label>
          <select class="select" id="m-area" onchange="updateSubareaOptions('m-subarea', this.value, '')">
            <option value="">None</option>
            ${AREA_KEYS.map(k => `<option value="${k}"${t.area===k?" selected":""}>${APP_AREAS[k].label}</option>`).join("")}
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Sub-area</label>
          <select class="select" id="m-subarea"${t.area ? "" : " disabled"}>
            ${t.area ? [`<option value="">None</option>`, ...getSubareas(t.area).map(s => `<option value="${s}"${t.subarea===s?" selected":""}>${s}</option>`)].join("") : `<option value="">Select area first</option>`}
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Files Affected</label>
        <input class="input" id="m-files" value="${esc(t.files || "")}" />
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" onclick="deleteTicket('${t.id}')">Delete</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="submitEditTicket('${t.id}')">Save</button>
    </div>
  `);
}

function submitEditTicket(id) {
  const t = DATA.tickets.find(x => x.id === id);
  if (!t) return;
  t.title = document.getElementById("m-title")?.value.trim() || t.title;
  t.description = document.getElementById("m-desc")?.value.trim() || "";
  t.type = document.getElementById("m-type")?.value || t.type;
  t.priority = document.getElementById("m-priority")?.value || t.priority;
  t.status = document.getElementById("m-status")?.value || t.status;
  t.area = document.getElementById("m-area")?.value || "";
  t.subarea = document.getElementById("m-subarea")?.value || "";
  t.assignee = document.getElementById("m-assignee")?.value.trim() || "";
  t.files = document.getElementById("m-files")?.value.trim() || "";
  t.updatedAt = now();
  const act = { action: "update", ticketId: t.id, title: `Updated: ${t.title}`, time: now() };
  addActivity(act.action, act.ticketId, act.title);
  apiUpdateTicket(t.id, { title: t.title, description: t.description, type: t.type, priority: t.priority, status: t.status, area: t.area, subarea: t.subarea, assignee: t.assignee, files: t.files, updatedAt: t.updatedAt }, act);
  closeModal();
  renderCurrentPage();

  // Regenerate ticket image based on updated details
  t.image = "";
  apiRegenerateImage(t.id);
  pollForTicketImage(t.id);
}

async function regenerateTicketImage(id) {
  const t = DATA.tickets.find(x => x.id === id);
  if (!t) return;
  t.image = "";
  renderCurrentPage();
  openTicketDetail(id);
  await apiRegenerateImage(id);
  pollForTicketImage(id);
}

function deleteTicket(id) {
  const t = DATA.tickets.find(x => x.id === id);
  if (!t) return;
  if (!confirm(`Delete "${t.title}"? This cannot be undone.`)) return;
  DATA.tickets = DATA.tickets.filter(x => x.id !== id);
  const act = { action: "delete", ticketId: id, title: `Deleted: ${t.title}`, time: now() };
  addActivity(act.action, act.ticketId, act.title);
  apiDeleteTicket(id, act);
  closeModal();
  closeDetail();
  renderCurrentPage();
}

// --- Ticket Detail ---
function openTicketDetail(id) {
  const t = DATA.tickets.find(x => x.id === id);
  if (!t) return;
  const statusLabel = { open: "Open", progress: "In Progress", review: "Review", done: "Done" };
  openDetail(`
    <div class="detail-header">
      <div class="detail-title-group">
        <div class="detail-title">${esc(t.title)}</div>
        <div class="detail-badges">
          <span class="badge badge-${t.type}">${esc(t.type)}</span>
          <span class="badge badge-${t.priority}">${esc(t.priority)}</span>
          <span class="badge badge-${t.status}">${esc(statusLabel[t.status] || t.status)}</span>
          ${t.area ? `<span class="badge badge-area">${esc(getAreaLabel(t.area))}</span>` : ""}
        </div>
      </div>
      <button class="btn-icon" onclick="closeDetail()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>

    ${t.image ? `
    <div>
      <img class="detail-hero-image" src="data:image/png;base64,${t.image}" alt="Ticket illustration" />
      <div class="detail-image-actions">
        <button class="btn btn-sm" onclick="regenerateTicketImage('${t.id}')" style="font-size:10px">Regenerate Image</button>
      </div>
    </div>` : ``}

    <div>
      <div class="detail-section-title">Description</div>
      <div class="detail-desc">${esc(t.description) || '<span style="opacity:0.4;font-style:italic">No description provided.</span>'}</div>
    </div>

    <div class="detail-fields-grid">
      <div class="detail-field">
        <div class="detail-field-label">ID</div>
        <div class="detail-field-value" style="font-family:monospace">${esc(t.id)}</div>
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Assignee</div>
        <div class="detail-field-value">${esc(t.assignee) || "\u2014"}</div>
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Created</div>
        <div class="detail-field-value">${formatTime(t.createdAt)}</div>
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Updated</div>
        <div class="detail-field-value">${formatTime(t.updatedAt || t.createdAt)}</div>
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Area</div>
        <div class="detail-field-value">${t.area ? esc(getAreaLabel(t.area)) : "\u2014"}</div>
      </div>
      <div class="detail-field">
        <div class="detail-field-label">Sub-area</div>
        <div class="detail-field-value">${t.subarea ? esc(t.subarea) : "\u2014"}</div>
      </div>
    </div>

    ${t.files ? `
      <div>
        <div class="detail-section-title">Files Affected</div>
        <div style="font-size:12px;font-family:monospace;line-height:1.6;color:var(--muted)">${esc(t.files).split(",").map(f => f.trim()).filter(Boolean).map(f => `<div>${f}</div>`).join("")}</div>
      </div>
    ` : ""}

    <div>
      <div class="detail-section-title">Notes</div>
      <div id="notes-container"><span class="notes-empty">Loading notes\u2026</span></div>
      <div class="note-form">
        <textarea id="note-content-input" placeholder="Add a note\u2026" rows="2"></textarea>
        <div class="note-form-row">
          <input id="note-author-input" type="text" placeholder="Your name" value="${esc(localStorage.getItem('bpm_note_author') || '')}" />
          <button class="btn btn-primary btn-sm" onclick="submitNote('${t.id}')">Add Note</button>
        </div>
      </div>
    </div>

    <div class="detail-actions">
      <button class="btn btn-primary" onclick="generatePromptForTicket('${t.id}');closeDetail()">Generate AI Prompt</button>
      <button class="btn" onclick="openEditTicketModal('${t.id}')">Edit</button>
      <button class="btn" onclick="cycleStatus('${t.id}');closeDetail()">Advance Status</button>
    </div>
  `);
  loadAndRenderNotes(id);
}

// --- Notes rendering & submission ---
function renderNotesSection(ticketId, notes) {
  const container = document.getElementById("notes-container");
  if (!container) return;
  if (!notes || notes.length === 0) {
    container.innerHTML = '<span class="notes-empty">No notes yet.</span>';
    return;
  }
  container.innerHTML = `<div class="notes-list">${notes.map(n => `
    <div class="note-item">
      <div class="note-dot"></div>
      <div class="note-body">
        <div class="note-content">${esc(n.content)}</div>
        <div class="note-meta">${esc(n.author || "Anonymous")} \u00b7 ${formatTime(n.createdAt)}</div>
      </div>
      <button class="note-delete-btn" title="Delete note" onclick="deleteNote('${ticketId}','${n.id}')">\u00d7</button>
    </div>
  `).join("")}</div>`;
}

async function loadAndRenderNotes(ticketId) {
  const notes = await apiGetNotes(ticketId);
  renderNotesSection(ticketId, notes);
}

async function submitNote(ticketId) {
  const contentEl = document.getElementById("note-content-input");
  const authorEl = document.getElementById("note-author-input");
  if (!contentEl || !authorEl) return;
  const content = contentEl.value.trim();
  if (!content) { contentEl.focus(); return; }
  const author = authorEl.value.trim() || "Anonymous";
  localStorage.setItem("bpm_note_author", author);
  contentEl.value = "";
  const created = await apiCreateNote(ticketId, { content, author });
  if (created) loadAndRenderNotes(ticketId);
}

async function deleteNote(ticketId, noteId) {
  if (!confirm("Delete this note?")) return;
  await apiDeleteNote(ticketId, noteId);
  loadAndRenderNotes(ticketId);
}

// === PROMPT LAB ===
let selectedPromptTicket = null;
let promptType = "implement";
let lastGeneratedPrompt = "";
let promptIsLoading = false;
let hasAnthropicKey = false;
let anthropicKeyHint = "";
let hasOpenAIKey = false;
let openaiKeyHint = "";
let imageStylePrompt = "";
let hasFreepikKey = false;
let freepikKeyHint = "";
let imageProvider = "openai";
let selectedProvider = "anthropic";
let selectedModel = "claude-sonnet-4-20250514";

const PROVIDERS = {
  anthropic: { label: "Anthropic", models: [
    { id: "claude-sonnet-4-20250514", name: "Claude Sonnet 4" },
    { id: "claude-haiku-4-20250414", name: "Claude Haiku 4" },
  ], hasKey: () => hasAnthropicKey },
  openai: { label: "OpenAI", models: [
    { id: "gpt-4o", name: "GPT-4o" },
    { id: "gpt-4o-mini", name: "GPT-4o Mini" },
  ], hasKey: () => hasOpenAIKey },
};

function renderPromptLab() {
  const openTickets = DATA.tickets.filter(t => t.status !== "done");
  const selectedTicket = selectedPromptTicket ? DATA.tickets.find(t => t.id === selectedPromptTicket) : null;

  const outputContent = promptIsLoading
    ? `<div class="prompt-loading"><div class="spinner"></div>Generating prompt with ${esc(PROVIDERS[selectedProvider].label)}\u2026</div>`
    : lastGeneratedPrompt
      ? simpleMarkdownToHtml(lastGeneratedPrompt)
      : '<span class="prompt-output-empty">Select a ticket to generate an AI-powered prompt for Claude Code.</span>';

  const providerHasKey = PROVIDERS[selectedProvider].hasKey();
  const providerModels = PROVIDERS[selectedProvider].models;

  document.getElementById("page-prompts").innerHTML = `
    <div class="page-title">Prompt Lab</div>
    <div class="page-subtitle">AI-powered prompts for Claude Code — informed by your Knowledge Base</div>

    <div class="prompt-layout">
      <div class="prompt-sidebar">
        <div class="section-title">Open Tickets</div>
        ${openTickets.length === 0 ? '<div class="empty-state"><div class="empty-state-sub">No open tickets. Create one in the Tracker.</div></div>' :
          openTickets.map(t => `
            <div class="prompt-ticket-card${selectedPromptTicket === t.id ? " selected" : ""}" onclick="selectPromptTicket('${t.id}')">
              ${t.image ? `<img class="prompt-ticket-thumb" src="data:image/png;base64,${t.image}" alt="" loading="lazy" />` : ``}
              <div style="display:flex;gap:6px;align-items:center;margin-bottom:4px;flex-wrap:wrap;">
                <span class="badge badge-${t.type}" style="font-size:9px">${esc(t.type)}</span>
                <span class="badge badge-${t.priority}" style="font-size:9px">${esc(t.priority)}</span>
                ${t.area ? `<span class="badge badge-area" style="font-size:9px">${esc(getAreaLabel(t.area))}</span>` : ""}
              </div>
              <div class="prompt-ticket-name">${esc(t.title)}</div>
              ${t.description ? `<div class="prompt-ticket-desc">${esc(t.description)}</div>` : ""}
            </div>
          `).join("")}
      </div>

      <div class="prompt-main">
        <div class="prompt-controls">
          <select class="prompt-provider-select" onchange="setProvider(this.value)">
            ${Object.entries(PROVIDERS).map(([k, v]) => `<option value="${k}"${selectedProvider===k?" selected":""}>${v.label}</option>`).join("")}
          </select>
          <select class="prompt-model-select" onchange="setModel(this.value)">
            ${providerModels.map(m => `<option value="${m.id}"${selectedModel===m.id?" selected":""}>${m.name}</option>`).join("")}
          </select>
          <div class="prompt-type-tabs">
            ${["implement","fix","refactor","test","review"].map(p => `<button class="prompt-type-tab${promptType===p?" active":""}" onclick="setPromptType('${p}')">${p.charAt(0).toUpperCase()+p.slice(1)}</button>`).join("")}
          </div>
          <div style="flex:1"></div>
          <button class="btn btn-sm" onclick="copyText(lastGeneratedPrompt)" ${!lastGeneratedPrompt||promptIsLoading?"disabled":""}>Copy</button>
          <button class="btn btn-primary btn-sm" onclick="generateAIPrompt()" ${!selectedPromptTicket||promptIsLoading||!providerHasKey?"disabled":""}>
            ${promptIsLoading ? "Generating\u2026" : "Generate"}
          </button>
        </div>
        ${!providerHasKey ? `<div style="font-size:11px;color:var(--runFailed);padding:4px 0;">No ${PROVIDERS[selectedProvider].label} API key configured. Click \u2699 to add one.</div>` : ""}

        <div class="prompt-ai-output" id="prompt-output">
          ${outputContent}
        </div>
      </div>
    </div>
  `;
}

function simpleMarkdownToHtml(md) {
  return md
    .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
    .replace(/^### (.+)$/gm, "<h3>$1</h3>")
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
    .replace(/^\- (.+)$/gm, "<li>$1</li>")
    .replace(/^\d+\. (.+)$/gm, "<li>$1</li>")
    .replace(/(<li>.*<\/li>\n?)+/g, (m) => "<ul>" + m + "</ul>")
    .replace(/\n{2,}/g, "</p><p>")
    .replace(/\n/g, "<br>")
    .replace(/^/, "<p>").replace(/$/, "</p>")
    .replace(/<p><h3>/g, "<h3>").replace(/<\/h3><\/p>/g, "</h3>")
    .replace(/<p><ul>/g, "<ul>").replace(/<\/ul><\/p>/g, "</ul>")
    .replace(/<p><\/p>/g, "");
}

function selectPromptTicket(id) {
  selectedPromptTicket = selectedPromptTicket === id ? null : id;
  lastGeneratedPrompt = "";
  renderPromptLab();
}

function setPromptType(type) {
  promptType = type;
  lastGeneratedPrompt = "";
  renderPromptLab();
}

function setProvider(value) {
  selectedProvider = value;
  selectedModel = PROVIDERS[value].models[0].id;
  lastGeneratedPrompt = "";
  renderPromptLab();
}

function setModel(value) {
  selectedModel = value;
}

function openAppSettings() {
  const renderSettingsContent = () => {
    const anthropicSection = hasAnthropicKey
      ? `<div class="settings-modal-row">
           <div class="settings-modal-status"><span class="dot"></span> Connected</div>
           <span class="settings-modal-hint">${esc(anthropicKeyHint)}</span>
           <button class="btn btn-sm" onclick="clearProviderKey('anthropic')" style="font-size:10px;padding:3px 8px">Remove</button>
         </div>`
      : `<div class="settings-modal-row">
           <input type="password" id="anthropic-key-input" placeholder="sk-ant-api03-..." />
           <button class="btn btn-primary btn-sm" onclick="saveProviderKey('anthropic')" style="font-size:10px;padding:3px 10px">Save</button>
         </div>`;

    const openaiSection = hasOpenAIKey
      ? `<div class="settings-modal-row">
           <div class="settings-modal-status"><span class="dot"></span> Connected</div>
           <span class="settings-modal-hint">${esc(openaiKeyHint)}</span>
           <button class="btn btn-sm" onclick="clearProviderKey('openai')" style="font-size:10px;padding:3px 8px">Remove</button>
         </div>`
      : `<div class="settings-modal-row">
           <input type="password" id="openai-key-input" placeholder="sk-..." />
           <button class="btn btn-primary btn-sm" onclick="saveProviderKey('openai')" style="font-size:10px;padding:3px 10px">Save</button>
         </div>`;

    const freepikSection = hasFreepikKey
      ? `<div class="settings-modal-row">
           <div class="settings-modal-status"><span class="dot"></span> Connected</div>
           <span class="settings-modal-hint">${esc(freepikKeyHint)}</span>
           <button class="btn btn-sm" onclick="clearProviderKey('freepik')" style="font-size:10px;padding:3px 8px">Remove</button>
         </div>`
      : `<div class="settings-modal-row">
           <input type="password" id="freepik-key-input" placeholder="fpk-..." />
           <button class="btn btn-primary btn-sm" onclick="saveProviderKey('freepik')" style="font-size:10px;padding:3px 10px">Save</button>
         </div>`;

    return `
      <div class="modal-header">
        <div class="modal-title">Settings</div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="settings-modal-section">
          <div class="settings-modal-label">Anthropic API Key</div>
          ${anthropicSection}
        </div>
        <div class="settings-modal-section">
          <div class="settings-modal-label">OpenAI API Key</div>
          ${openaiSection}
        </div>
        <div class="settings-modal-section">
          <div class="settings-modal-label">Freepik API Key</div>
          ${freepikSection}
        </div>
        <div style="font-size:10px;color:var(--muted);margin-top:4px;line-height:1.5;">
          API keys are stored securely on the server and never exposed to the browser.
        </div>
        <hr style="border:none;border-top:1px solid color-mix(in srgb, var(--border) 10%, transparent);margin:16px 0;" />
        <div class="settings-modal-section">
          <div class="settings-modal-label">Image Generation Provider</div>
          <div style="font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.4;">
            Choose which AI provider generates ticket card images.
          </div>
          <select id="image-provider-select" class="select" style="font-size:12px;" onchange="saveImageProvider(this.value)">
            <option value="openai"${imageProvider === "openai" ? " selected" : ""}>OpenAI (GPT Image 1)</option>
            <option value="freepik"${imageProvider === "freepik" ? " selected" : ""}>Freepik (Seedream 4.5)</option>
          </select>
        </div>
        <div class="settings-modal-section">
          <div class="settings-modal-label">Image Generation Style</div>
          <div style="font-size:10px;color:var(--muted);margin-bottom:6px;line-height:1.4;">
            Customize the base style instruction for AI-generated ticket images. Leave blank to use the default Japanese flat illustration style.
          </div>
          <textarea id="image-style-input" class="textarea" rows="4" style="font-size:11px;resize:vertical;" placeholder="A 2D Japanese flat illustration in ukiyo-e inspired style with clean bold outlines, flat color fills, and muted earth tones...">${esc(imageStylePrompt)}</textarea>
          <div style="display:flex;gap:6px;margin-top:6px;">
            <button class="btn btn-primary btn-sm" onclick="saveImageStylePrompt()" style="font-size:10px;padding:3px 10px">Save Style</button>
            <button class="btn btn-sm" onclick="clearImageStylePrompt()" style="font-size:10px;padding:3px 8px">Reset to Default</button>
          </div>
        </div>
      </div>
    `;
  };

  openModal(renderSettingsContent());

  // Store re-render function globally so save/clear can refresh the modal
  window._refreshSettingsModal = () => {
    modalEl.innerHTML = renderSettingsContent();
  };
}

function saveProviderKey(provider) {
  const inputIds = { anthropic: "anthropic-key-input", openai: "openai-key-input", freepik: "freepik-key-input" };
  const input = document.getElementById(inputIds[provider]);
  const key = input?.value?.trim();
  if (!key) return;

  saveSettings({ [provider + "_api_key"]: key });

  if (provider === "anthropic") {
    hasAnthropicKey = true;
    anthropicKeyHint = "sk-ant-\u2022\u2022\u2022" + key.slice(-4);
  } else if (provider === "openai") {
    hasOpenAIKey = true;
    openaiKeyHint = "sk-\u2022\u2022\u2022" + key.slice(-4);
  } else if (provider === "freepik") {
    hasFreepikKey = true;
    freepikKeyHint = "fpk-\u2022\u2022\u2022" + key.slice(-4);
  }

  const labels = { anthropic: "Anthropic", openai: "OpenAI", freepik: "Freepik" };
  showToast(`${labels[provider]} API key saved`);
  if (window._refreshSettingsModal) window._refreshSettingsModal();
  if (provider !== "freepik") renderPromptLab();
}

function clearProviderKey(provider) {
  saveSettings({ [provider + "_api_key"]: "" });

  if (provider === "anthropic") {
    hasAnthropicKey = false;
    anthropicKeyHint = "";
  } else if (provider === "openai") {
    hasOpenAIKey = false;
    openaiKeyHint = "";
  } else if (provider === "freepik") {
    hasFreepikKey = false;
    freepikKeyHint = "";
  }

  const labels = { anthropic: "Anthropic", openai: "OpenAI", freepik: "Freepik" };
  showToast(`${labels[provider]} API key removed`);
  if (window._refreshSettingsModal) window._refreshSettingsModal();
  if (provider !== "freepik") renderPromptLab();
}

function saveImageStylePrompt() {
  const val = document.getElementById("image-style-input")?.value?.trim() || "";
  imageStylePrompt = val;
  saveSettings({ image_style_prompt: val });
  showToast("Image style prompt saved");
  if (window._refreshSettingsModal) window._refreshSettingsModal();
}

function clearImageStylePrompt() {
  imageStylePrompt = "";
  saveSettings({ image_style_prompt: "" });
  showToast("Image style reset to default");
  if (window._refreshSettingsModal) window._refreshSettingsModal();
}

function saveImageProvider(value) {
  imageProvider = value;
  saveSettings({ image_provider: value });
  showToast(`Image provider set to ${value === "freepik" ? "Freepik Seedream 4.5" : "OpenAI GPT Image 1"}`);
}

async function generateAIPrompt() {
  const ticket = selectedPromptTicket ? DATA.tickets.find(t => t.id === selectedPromptTicket) : null;
  if (!ticket || !PROVIDERS[selectedProvider].hasKey()) return;

  promptIsLoading = true;
  lastGeneratedPrompt = "";
  renderPromptLab();

  const systemPrompt = buildAISystemPrompt();
  const userMessage = buildAIUserMessage(ticket, promptType);

  try {
    const res = await fetch(`${API_BASE}/api/ai/prompt`, {
      method: "POST",
      headers: JSON_HEADERS,
      body: JSON.stringify({
        provider: selectedProvider,
        model: selectedModel,
        system: systemPrompt,
        messages: [{ role: "user", content: userMessage }],
      }),
    });
    const data = await res.json();

    if (data.error) {
      lastGeneratedPrompt = "Error: " + data.error;
    } else {
      lastGeneratedPrompt = data.content || "No response generated.";
    }

    // Log activity
    const providerLabel = PROVIDERS[selectedProvider].label;
    const act = { action: "prompt", ticketId: ticket.id, title: `AI ${promptType} prompt (${providerLabel}): ${ticket.title}`, time: now() };
    addActivity(act.action, act.ticketId, act.title);
    apiUpdateTicket(ticket.id, { updatedAt: ticket.updatedAt }, act);
  } catch (err) {
    lastGeneratedPrompt = "Error: " + err.message;
  }

  promptIsLoading = false;
  renderPromptLab();
}

function generatePromptForTicket(id) {
  selectedPromptTicket = id;
  const t = DATA.tickets.find(x => x.id === id);
  promptType = t?.type === "bug" ? "fix" : "implement";
  lastGeneratedPrompt = "";
  // Switch to prompt lab
  currentPage = "prompts";
  document.querySelectorAll(".shell-nav-btn").forEach(b => b.classList.toggle("active", b.dataset.page === "prompts"));
  document.querySelectorAll(".page").forEach(p => p.classList.toggle("active", p.id === "page-prompts"));
  renderPromptLab();
}

function buildAISystemPrompt() {
  return `You are a prompt engineer for BPM (BentoBase Performance Manager). Your job is to write clear, actionable prompts that a developer would give to Claude Code to implement work on the BentoBase platform.

BentoBase is a sovereignty-first AI flow editor — a vanilla JavaScript single-page application where users build AI workflows by connecting nodes on a canvas, define intelligent agents, and manage data locally.

Key platform context:
- No frameworks (vanilla JS, ES modules, no React/Vue)
- Unidirectional state store (dispatch/reduce pattern)
- CSS custom properties for theming (6 themes)
- Local-first: all data persists to local JSON files
- Electron-ready for desktop packaging
- Layered architecture: UI > Canvas > State > Graph > Runtime > Storage > API

IMPORTANT RULES FOR YOUR PROMPTS:
- Describe DESIRED FUNCTIONALITY and BEHAVIOR, not specific files or code implementations
- Focus on what the user experience should be, not how to code it
- Reference the platform's design principles (sovereignty, no frameworks, local-first)
- Be specific about expected behavior, edge cases, and user interactions
- Never suggest specific file paths, function names, or code snippets
- Never recommend third-party libraries or dependencies
- Frame everything in terms of what the feature should DO, not how to BUILD it
- Keep prompts concise but thorough — a developer should understand exactly what to build`;
}

function buildAIUserMessage(ticket, type) {
  const parts = [];
  parts.push(`Generate a ${type} prompt for Claude Code based on this ticket:\n`);
  parts.push(`Title: ${ticket.title}`);
  parts.push(`Type: ${ticket.type} | Priority: ${ticket.priority} | Status: ${ticket.status}`);
  if (ticket.area) parts.push(`Area: ${getAreaLabel(ticket.area)}${ticket.subarea ? " > " + ticket.subarea : ""}`);
  if (ticket.description) parts.push(`\nDescription:\n${ticket.description}`);

  // Add KB context for the area
  const kbCtx = getKBContextForArea(ticket.area);
  if (kbCtx) {
    parts.push(`\nKnowledge Base context for this area:\n${kbCtx}`);
  }

  // Add prompt type guidance
  const typeGuidance = {
    implement: "Write a prompt that describes the feature to implement. Focus on user-facing behavior, interactions, and expected outcomes.",
    fix: "Write a prompt that describes the bug to fix. Focus on the incorrect behavior, what the correct behavior should be, and any user-visible impact.",
    refactor: "Write a prompt that describes what to refactor and why. Focus on the desired improvements to code quality, performance, or maintainability without changing behavior.",
    test: "Write a prompt that describes what to test. Focus on scenarios, edge cases, expected outcomes, and acceptance criteria.",
    review: "Write a prompt that asks for a review of this area. Focus on correctness, security, performance, and adherence to platform conventions.",
  };
  parts.push(`\nPrompt type: ${type}`);
  parts.push(typeGuidance[type] || typeGuidance.implement);

  return parts.join("\n");
}

function getKBContextForArea(area) {
  const ctx = {
    login:      "Login Screen: PIN-based local auth, session management, splash screen with rotating philosophical quotes and usage tips, lockout after failed attempts. No remote auth server. Key concern: PIN storage security, session timeout handling.",
    agents:     "Agents: Logical actors (local model, remote model, or deterministic tool) with classifications (Observer, Analyst, Orchestrator, Operator, Archivist). Agents do not own flows; flows invoke agents. Managed by a dedicated server on port 3009 via REST API. Each agent has capabilities, memory settings, behavior config, and collaborator links. Agent nodes in flows reference agents by ID.",
    flows:      "Flows & Canvas: A flow is a declarative graph that defines context ingress, transformation, policy boundaries, routing, and computation. Flows are long-lived artifacts, not ephemeral sessions. Execution belongs to the runtime server, not the UI. Visual editor with infinite pan/zoom canvas, SubFlow nesting, and Inspector panel (Properties, Library, Agents tabs). Node taxonomy: Input, Transform, Masking, Model, Memory, Routing, Output, Signal. Masking is first-class \u2014 a structural boundary between raw context and computation. Keyboard shortcuts: Space+drag to pan, Ctrl/Cmd+scroll to zoom, F to reset zoom, Shift to reveal thumbnails/ports, Tab for flow nav, Backspace/Delete to remove selected, Ctrl/Cmd+Z/Shift+Z for undo/redo, Ctrl/Cmd+S to save, Shift+drag for axis lock.",
    data:       "Data: Local-first data management \u2014 connections to external sources, file uploads, knowledge bases for RAG. All files stored locally. Data preview for inspecting contents before use in flows.",
    interfaces: "Interfaces: A presentation layer bound to flows. Logic lives in flows, not in UI. Visual builder with grid/flex layout, pre-built components (inputs, buttons, displays), and live preview. Allows non-technical users to interact with complex flows through simple forms and dashboards.",
    community:  "Community & Ecosystem: BentoBase is a publishing and exchange layer. Marketplace is a monetization layer where creators sell or license agents, flows, interfaces, and artifacts. Enterprises procure vetted components. Every shared item ships with provenance, permissions, and an inspectable graph. Discussion, My Store, ratings/reviews, search/filter. Features 3D tilt card effects.",
    showcase:   "Showcase: A browsable gallery of published artifacts and experiences \u2014 dashboards, interactive films, games, music, educational applications, templates, and personal uploads \u2014 meant to be experienced first, inspected second. Full-screen viewer, featured picks, category browsing.",
    settings:   "Settings: API provider configuration (OpenAI, Anthropic, local models), backend service connections, MCP server management, user account/profile, and theme selection. All settings persist locally.",
    security:   "Security: Sovereignty-first model \u2014 all data local, no telemetry, opt-in remote services. Every tool call is declared, scoped, and enforceable. Permissions, data boundaries, and allowed operations are part of the graph. Inspectable provenance on every artifact. Key concerns: PIN storage, API key encryption at rest, input sanitization (XSS prevention), Electron sandboxing, CSP headers.",
    structure:  "App Structure: Vanilla JS with ES modules, no frameworks. MCP-native \u2014 treats Model Context Protocol as the default contract for tool access, context exchange, and agent interoperability. Layered architecture (UI > Canvas > State > Graph > Runtime > Storage > API). Flows target MCP tools by contract for portable execution across environments. Single CSS file with custom properties for theming. Electron packaging for desktop.",
    ux:         "UX & Design: Calm, modern, confident, and obvious. No 'AI magic' aesthetics. No hidden state. Clarity beats cleverness. 6 themes using CSS custom properties. Consistent 44px header, 11px uppercase tab labels, 150ms transitions, color-mix() for transparency. Empty states with centered icon+message. The UI teaches through plain language and consistent diagram grammar.",
    perf:       "Performance: Canvas rendering with DOM nodes (not canvas/WebGL). Potential concerns: large flow re-renders, memory with many nodes, DOM update batching, localStorage size limits, efficient edge routing calculations.",
    docs:       "Documentation: Knowledge base maintained in the BPM portal. Inline code comments follow JSDoc conventions where present. README covers setup and architecture. No external documentation site currently.",
    portal:     "Dev Dashboard (BPM): Separate self-contained portal for project management. SQLite-backed API server, ticket tracking, prompt generation, knowledge base, kanban roadmap. Fully independent from the BentoBase app \u2014 no shared code, imports, or data.",
  };
  return ctx[area] || "";
}

// === KNOWLEDGE BASE ===
let kbSection = "architecture";

const KB_SECTIONS = {
  architecture: { label: "Architecture", render: renderKBArchitecture },
  fileMap: { label: "File Map", render: renderKBFileMap },
  howItWorks: { label: "How It Works", render: renderKBHowItWorks },
  flowsCanvas: { label: "Flows & Canvas", render: renderKBFlowsCanvas },
  nodes: { label: "Node System", render: renderKBNodes },
  agents: { label: "Agents", render: renderKBAgents },
  dataInterfaces: { label: "Data & Interfaces", render: renderKBDataInterfaces },
  communityShowcase: { label: "Community & Showcase", render: renderKBCommunityShowcase },
  loginSettings: { label: "Login & Settings", render: renderKBLoginSettings },
  themes: { label: "Theming & UX", render: renderKBThemes },
  toneVoice: { label: "Tone & Voice", render: renderKBToneVoice },
  security: { label: "Security", render: renderKBSecurity },
  conventions: { label: "Conventions", render: renderKBConventions },
};

function renderKB() {
  document.getElementById("page-kb").innerHTML = `
    <div class="page-title">Knowledge Base</div>
    <div class="page-subtitle">Canonical reference for the BentoBase codebase &mdash; managed by BPM</div>

    <div class="kb-layout">
      <div class="kb-nav">
        ${Object.entries(KB_SECTIONS).map(([key, sec]) => `
          <button class="kb-nav-item${kbSection === key ? " active" : ""}" onclick="setKBSection('${key}')">${sec.label}</button>
        `).join("")}
      </div>
      <div class="kb-content" id="kb-content"></div>
    </div>
  `;
  (KB_SECTIONS[kbSection]?.render || (() => {}))();
}

function setKBSection(key) {
  kbSection = key;
  renderKB();
}

function renderKBArchitecture() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Architecture Overview</h2>

    <h3>What BentoBase Is</h3>
    <p>BentoBase is a local-first, production-grade control plane for building and operating agentic systems with explicit, inspectable flows \u2014 and a shared ecosystem where those systems, artifacts, and outcomes can be exchanged.</p>
    <p>It is a visual authoring and inspection environment where you compose flows as declarative graphs: how inputs enter, how context is transformed, where privacy boundaries are enforced, how models and tools are invoked, how memory is scoped, how routing decisions are made, and how outputs are delivered. Flows are long-lived artifacts, not ephemeral sessions. Execution belongs to the runtime server, not the UI.</p>
    <p>BentoBase is also a publishing and exchange layer: a place where individuals, communities, and enterprises share agents, flows, and the outputs those designs produce \u2014 safely, visibly, and with clear provenance.</p>

    <h3>Core Mission</h3>
    <p>Operationalize agentic systems by making their logic explicit, constrainable, and auditable \u2014 then make that work composable and distributable so value can compound across a network.</p>
    <p>BentoBase's job is not to "be smart." Its job is to make AI systems legible, governable, and trustworthy over time by forcing their behavior into visible structure, then enabling creators to publish what they build.</p>

    <h3>Core Concepts</h3>
    <table class="kb-table">
      <thead><tr><th>Concept</th><th>Definition</th></tr></thead>
      <tbody>
        <tr><td><strong>Agent</strong></td><td>A logical actor \u2014 local model, remote model, or deterministic tool. Agents do not own flows; flows invoke agents.</td></tr>
        <tr><td><strong>Flow</strong></td><td>A declarative graph that defines context ingress, transformation, policy boundaries, routing, and computation.</td></tr>
        <tr><td><strong>Runtime Server</strong></td><td>The executor that runs flows, enforces policy, manages state, and mediates access to models and tools.</td></tr>
        <tr><td><strong>Interface</strong></td><td>A presentation layer bound to flows. Logic lives in flows, not in UI.</td></tr>
        <tr><td><strong>Artifact</strong></td><td>A published output \u2014 dashboard, interactive film, game, music experience, educational app, dataset, or template \u2014 generated by or bound to flows.</td></tr>
      </tbody>
    </table>

    <h3>Non-Goals</h3>
    <p>BentoBase is not a chat app, not a prompt playground, not a low-code toy, and not a model hosting platform. It does not hide complexity or "just make it work." If something works without being explainable, that is a product failure.</p>

    <h3>Design Principles</h3>
    <p><strong>No frameworks.</strong> The app is built with plain JavaScript and standard web technologies. No third-party UI libraries. This keeps the codebase simple and under full control.</p>
    <p><strong>Declarative nodes.</strong> Nodes on the canvas describe <em>what</em> should happen (metadata, labels, connections) but don't contain execution logic themselves. A separate runtime layer handles the actual processing.</p>
    <p><strong>Data stays local.</strong> All user data \u2014 flows, agents, settings \u2014 is saved to local files on the user's machine. Cloud services are available but always opt-in and scoped to specific tasks.</p>
    <p><strong>Electron-ready.</strong> The app runs in a browser during development and can be packaged as a native desktop application using Electron.</p>
    <p><strong>MCP-native.</strong> BentoBase treats the Model Context Protocol as the default contract for tool access, context exchange, and agent interoperability \u2014 so integrations are composable, governable, and portable across environments.</p>

    <h3>MCP-Native Integration</h3>
    <table class="kb-table">
      <thead><tr><th>Principle</th><th>What it means</th></tr></thead>
      <tbody>
        <tr><td><strong>Tooling as MCP</strong></td><td>Enterprise systems are accessed through MCP-native connectors that expose bounded capabilities as tools, not as opaque code paths.</td></tr>
        <tr><td><strong>Portable Execution</strong></td><td>Flows target MCP tools by contract, enabling the same flow to run across dev, community, and enterprise environments with only connector substitution.</td></tr>
        <tr><td><strong>Governed Access</strong></td><td>Every tool call is declared, scoped, and enforceable. Permissions, data boundaries, and allowed operations are part of the graph.</td></tr>
        <tr><td><strong>Inspectable Provenance</strong></td><td>Each artifact and flow includes provenance metadata \u2014 what tools it can call, what data classes it can touch, what it emits, and who authored or modified it.</td></tr>
        <tr><td><strong>Enterprise Readiness</strong></td><td>Designed to integrate with identity and access control, audit logging, policy enforcement, and existing systems of record.</td></tr>
      </tbody>
    </table>

    <h3>How the App is Organized</h3>
    <p>The app is built in layers, where each layer has a specific job:</p>
    <pre><code>UI Layer        \u2502 What the user sees and interacts with (tabs, panels, forms)
Canvas Layer    \u2502 The visual graph editor (pan, zoom, drag, connect nodes)
State Layer     \u2502 Manages all app data in one central place
Graph Layer     \u2502 Defines node types, sizes, categories, and validation
Runtime Layer   \u2502 Executes the workflow when a flow is run
Storage Layer   \u2502 Reads and writes flows/agents to local JSON files
API Layer       \u2502 Communicates with external services (MCP servers, agents server)</code></pre>

    <h3>How a User Action Flows Through the System</h3>
    <p>When a user does something (like dragging a node), the app follows this path:</p>
    <pre><code>1. User interacts with the UI (click, drag, type)
2. The UI dispatches an "action" describing what happened
3. A central reducer processes the action and produces updated state
4. The UI re-renders based on the new state
5. If the change affects saved data, the storage layer writes it to disk</code></pre>
    <p>This one-way flow keeps things predictable: the current state is always the single source of truth.</p>
  `;
}

function renderKBFileMap() {
  document.getElementById("kb-content").innerHTML = `
    <h2>File Map</h2>
    <p>Every file in the BentoBase app has a specific role. Here's where to find things:</p>

    <h3>State Management (the brain)</h3>
    <table class="kb-table">
      <thead><tr><th>File</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td><code>src/state/schema.js</code></td><td>Defines all node types and contains the factory functions that create new nodes, edges, agents, and subflows</td></tr>
        <tr><td><code>src/state/actions.js</code></td><td>Lists every action the app can perform (add node, move node, load flow, etc.)</td></tr>
        <tr><td><code>src/state/store.js</code></td><td>The central data store \u2014 holds the current state and notifies the UI when things change</td></tr>
        <tr><td><code>src/state/reducer.js</code></td><td>Processes actions and updates the state accordingly</td></tr>
      </tbody>
    </table>

    <h3>Graph & Nodes (the building blocks)</h3>
    <table class="kb-table">
      <thead><tr><th>File</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td><code>src/graph/nodeDefaults.js</code></td><td>Defines categories, sizes, and default settings for each node type</td></tr>
        <tr><td><code>src/graph/schemaHints.js</code></td><td>Suggests port connections based on what upstream nodes output</td></tr>
        <tr><td><code>src/runtime/nodes/*.js</code></td><td>One file per node type \u2014 contains the actual execution logic (conditional routing, memory, etc.)</td></tr>
      </tbody>
    </table>

    <h3>Canvas (the visual editor)</h3>
    <table class="kb-table">
      <thead><tr><th>File</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td><code>src/canvas/dragCreate.js</code></td><td>Handles dragging new nodes onto the canvas from the palette, library, or agents tab</td></tr>
        <tr><td><code>src/canvas/pan.js</code></td><td>Lets users pan and zoom the canvas with mouse or trackpad</td></tr>
        <tr><td><code>src/canvas/camera.js</code></td><td>Math for converting between screen coordinates and canvas coordinates</td></tr>
        <tr><td><code>src/canvas/connect.js</code></td><td>Handles drawing edges (connections) between node ports</td></tr>
      </tbody>
    </table>

    <h3>User Interface (what users see)</h3>
    <table class="kb-table">
      <thead><tr><th>File</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td><code>src/ui/editor.js</code></td><td>The main flow editor \u2014 toolbar, node palette, canvas, and the inspector panel (Properties, Library, Agents tabs)</td></tr>
        <tr><td><code>src/ui/nodeView.js</code></td><td>Renders individual nodes on the canvas (shapes, labels, ports, badges)</td></tr>
        <tr><td><code>src/ui/agents.js</code></td><td>The Agents workspace tab \u2014 list, detail, and editor views for managing agents</td></tr>
        <tr><td><code>src/ui/agentEditor.js</code></td><td>The form for creating and editing agents, including classification options</td></tr>
        <tr><td><code>src/ui/shell.js</code></td><td>The app shell \u2014 top tab bar, theme switcher, and page navigation</td></tr>
        <tr><td><code>src/ui/community.js</code></td><td>Community page \u2014 marketplace and discussion features</td></tr>
        <tr><td><code>src/ui/communityMarketplace.js</code></td><td>Marketplace browsing, ratings, search, and filtering</td></tr>
        <tr><td><code>src/ui/communityMyStore.js</code></td><td>User's own store for publishing and managing shared items</td></tr>
        <tr><td><code>src/app.css</code></td><td>All visual styles \u2014 themes, layout, every component in the app</td></tr>
      </tbody>
    </table>

    <h3>Storage & APIs (saving and communicating)</h3>
    <table class="kb-table">
      <thead><tr><th>File</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td><code>src/storage/flows.js</code></td><td>Saves and loads flows from local JSON files (create, read, update, delete, duplicate)</td></tr>
        <tr><td><code>src/api/mcpClient.js</code></td><td>Communicates with MCP servers for flow execution</td></tr>
        <tr><td><code>src/api/agentsClient.js</code></td><td>Communicates with the agents server (runs on port 3009)</td></tr>
      </tbody>
    </table>
  `;
}

function renderKBHowItWorks() {
  document.getElementById("kb-content").innerHTML = `
    <h2>How It Works</h2>
    <p>This section explains the key patterns used throughout BentoBase. Understanding these will help when reading or modifying any part of the app.</p>

    <h3>The State Store (Central Data)</h3>
    <p>The app keeps all of its current data in a single "store." Think of it like a central database that the entire app reads from and writes to. When something changes, the store notifies the UI to update.</p>
    <pre><code>What's in the store:
\u2022 The current flow (its nodes, edges, viewport position)
\u2022 Which nodes are selected
\u2022 The navigation stack (breadcrumb trail when inside sub-flows)
\u2022 The clipboard (for copy/paste)</code></pre>

    <h3>Actions (How Changes Happen)</h3>
    <p>Every change goes through an "action" \u2014 a simple message that describes what happened. The most common ones:</p>
    <table class="kb-table">
      <thead><tr><th>Action</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td>NODE_ADD</td><td>Places a new node on the canvas</td></tr>
        <tr><td>NODE_REMOVE</td><td>Deletes a node and its connections</td></tr>
        <tr><td>NODE_MOVE</td><td>Updates where a node sits on the canvas</td></tr>
        <tr><td>EDGE_ADD</td><td>Draws a connection between two node ports</td></tr>
        <tr><td>FLOW_LOAD</td><td>Opens a saved flow (replaces current canvas contents)</td></tr>
        <tr><td>SELECT_NODE</td><td>Highlights a node so its properties appear in the inspector</td></tr>
      </tbody>
    </table>

    <h3>Rendering Cycle</h3>
    <p>When the state changes, the app re-renders the UI from scratch based on the new state. This is simple and predictable \u2014 the UI is always a direct reflection of the data.</p>

    <h3>Adding a New Node Type (Checklist)</h3>
    <p>When a new type of node needs to be added, these files are typically touched:</p>
    <pre><code>1. schema.js       \u2192 Register the type and create a factory function for it
2. nodeDefaults.js  \u2192 Define its category, default size, and port configuration
3. dragCreate.js    \u2192 Handle dropping it onto the canvas
4. nodeView.js      \u2192 Define how it looks (shape, colors, labels)
5. app.css          \u2192 Add any custom visual styles
6. runtime/nodes/   \u2192 (If it runs logic) Add an executor file</code></pre>

    <h3>Adding a New Inspector Tab (Checklist)</h3>
    <p>The inspector panel on the right side of the flow editor uses a tab system. To add a new tab:</p>
    <pre><code>1. Add a tab button in the editor HTML
2. Add a content area for the tab body
3. Register it in the tab-switching function
4. Write a render function that fills in the content</code></pre>

    <h3>Drag-and-Drop</h3>
    <p>Users create nodes by dragging from three sources, each identified by a specific data type:</p>
    <table class="kb-table">
      <thead><tr><th>Drag source</th><th>What it creates</th></tr></thead>
      <tbody>
        <tr><td>Node palette (left sidebar)</td><td>A standard node of the selected type</td></tr>
        <tr><td>Library tab (inspector)</td><td>A SubFlow node referencing a saved flow</td></tr>
        <tr><td>Agents tab (inspector)</td><td>An Agent node referencing a defined agent</td></tr>
      </tbody>
    </table>

    <h3>Recursion Safety</h3>
    <p>The app prevents infinite loops when flows reference each other. Three safety checks exist:</p>
    <pre><code>1. SubFlow drop check \u2014 Prevents embedding a flow inside itself or its ancestors
2. Agent drop check   \u2014 Prevents agent-to-flow-to-agent circular chains
3. Execution sort     \u2014 At runtime, detects any remaining cycles in the graph</code></pre>
  `;
}

function renderKBFlowsCanvas() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Flows & Canvas</h2>
    <p>The flow editor is the heart of BentoBase. Users build AI workflows by placing nodes on a canvas and connecting them with edges.</p>

    <h3>What is a Flow?</h3>
    <p>A flow is a visual workflow \u2014 a collection of nodes connected by edges that defines how data moves through a processing pipeline. Each flow has:</p>
    <pre><code>\u2022 A name and description
\u2022 A list of nodes (the processing steps)
\u2022 A list of edges (the connections between steps)
\u2022 A viewport (where the camera is positioned)
\u2022 Associated agents (which AI agents participate)</code></pre>

    <h3>The Canvas</h3>
    <p>The canvas is an infinite 2D workspace where nodes are placed. Users can:</p>
    <pre><code>\u2022 Pan (scroll) the view in any direction
\u2022 Zoom in and out
\u2022 Drag nodes to reposition them
\u2022 Draw connections between ports by clicking and dragging
\u2022 Select nodes to see their properties in the inspector
\u2022 Drop new nodes from the palette, library, or agents tab</code></pre>

    <h3>Canvas Navigation & Keyboard Shortcuts</h3>
    <p>The canvas supports mouse, trackpad, and keyboard shortcuts for efficient navigation:</p>

    <table class="kb-table">
      <thead><tr><th>Shortcut</th><th>What it does</th></tr></thead>
      <tbody>
        <tr><td><strong>Scroll / Trackpad swipe</strong></td><td>Pan the canvas (vertical and horizontal)</td></tr>
        <tr><td><strong>Space + drag</strong></td><td>Pan the canvas with grab cursor</td></tr>
        <tr><td><strong>Ctrl/Cmd + scroll</strong></td><td>Zoom in and out (also handles trackpad pinch-to-zoom)</td></tr>
        <tr><td><strong>Alt/Option + scroll</strong></td><td>Zoom in and out</td></tr>
        <tr><td><strong>F</strong></td><td>Reset zoom to 100% while keeping canvas center</td></tr>
        <tr><td><strong>Shift (hold)</strong></td><td>Reveal node thumbnails and port names on the canvas</td></tr>
        <tr><td><strong>Tab</strong></td><td>Toggle the flow navigation overlay (switch between flows)</td></tr>
        <tr><td><strong>Escape</strong></td><td>Close overlays, cancel port connection in progress</td></tr>
        <tr><td><strong>Backspace / Delete</strong></td><td>Delete selected nodes and edges</td></tr>
        <tr><td><strong>Ctrl/Cmd + S</strong></td><td>Save the current flow</td></tr>
        <tr><td><strong>Ctrl/Cmd + Z</strong></td><td>Undo last action</td></tr>
        <tr><td><strong>Ctrl/Cmd + Shift + Z</strong></td><td>Redo last undone action</td></tr>
        <tr><td><strong>Ctrl/Cmd + L</strong></td><td>Lock the app (if a PIN is set)</td></tr>
        <tr><td><strong>Shift + drag node</strong></td><td>Axis-lock movement (restrict to horizontal or vertical)</td></tr>
        <tr><td><strong>Shift + click</strong></td><td>Add to current selection (multi-select)</td></tr>
      </tbody>
    </table>

    <p>Zoom range is 25% to 250%. All keyboard shortcuts are disabled when typing in text fields.</p>

    <h3>SubFlows (Nested Flows)</h3>
    <p>A flow can contain another flow as a "SubFlow" node. This allows complex workflows to be broken into manageable pieces. When you double-click a SubFlow node, you navigate inside it. A breadcrumb trail lets you navigate back up to the parent flow.</p>
    <p>Inside a SubFlow, a special "Flow Interface" node shows where data enters and exits, connecting the inner flow to the outer one.</p>

    <h3>The Inspector Panel</h3>
    <p>The inspector sits on the right side of the editor and has three tabs:</p>
    <table class="kb-table">
      <thead><tr><th>Tab</th><th>Purpose</th></tr></thead>
      <tbody>
        <tr><td>Properties</td><td>Shows details of the selected node \u2014 name, type, metadata, annotations, ports</td></tr>
        <tr><td>Library</td><td>Lists all saved flows. Drag one onto the canvas to embed it as a SubFlow.</td></tr>
        <tr><td>Agents</td><td>Lists all defined agents. Drag one onto the canvas to create an Agent node.</td></tr>
      </tbody>
    </table>

    <h3>Storage</h3>
    <p>Flows are saved as JSON files on the local filesystem. The storage layer provides standard create, read, update, delete, and duplicate operations. Flows are auto-saved when changes are made.</p>
  `;
}

function renderKBNodes() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Node System</h2>
    <p>Nodes are the building blocks of every flow. Each node represents a step in the workflow and has inputs (where data comes in) and outputs (where data goes out). The stable taxonomy is: <strong>Input \u00b7 Transform \u00b7 Masking \u00b7 Model \u00b7 Memory \u00b7 Routing \u00b7 Output \u00b7 Signal</strong>.</p>

    <h3>Node Categories</h3>
    <table class="kb-table">
      <thead><tr><th>Category</th><th>What it does</th><th>Examples</th></tr></thead>
      <tbody>
        <tr><td><strong>Input</strong></td><td>Brings data into the flow from external sources</td><td>File input, API input, form input, sensor input</td></tr>
        <tr><td><strong>Signal</strong></td><td>Triggers the flow based on events or conditions</td><td>Network signal, system health check, external event</td></tr>
        <tr><td><strong>Transform</strong></td><td>Cleans, reshapes, or converts data passing through</td><td>Normalize, format conversion, extract fields, parse</td></tr>
        <tr><td><strong>Masking</strong></td><td>Protects sensitive data by hiding or replacing it. Masking is first-class: a structural boundary between raw context and computation. Downstream models should not see original sensitive data unless an explicit, permitted step allows it.</td><td>Text anonymization, image redaction, token substitution</td></tr>
        <tr><td><strong>Model</strong></td><td>Sends data to an AI model for processing</td><td>Local model, remote model (GPT, Claude), media generator</td></tr>
        <tr><td><strong>Memory</strong></td><td>Stores and retrieves information across interactions</td><td>Session memory, short-term memory, long-term memory</td></tr>
        <tr><td><strong>Routing</strong></td><td>Directs data down different paths based on conditions</td><td>Conditional routing, priority routing, weighted routing</td></tr>
        <tr><td><strong>Output</strong></td><td>Delivers results to the user or external systems</td><td>Text output, media output, database write, webhook</td></tr>
        <tr><td><strong>SubFlow</strong></td><td>Embeds an entire saved flow as a single reusable step</td><td>(Created by dragging from the Library tab)</td></tr>
        <tr><td><strong>Agent</strong></td><td>References a defined AI agent with specific capabilities</td><td>(Created by dragging from the Agents tab)</td></tr>
      </tbody>
    </table>

    <h3>What a Node Contains</h3>
    <p>Every node on the canvas stores:</p>
    <pre><code>\u2022 A unique ID and type (e.g., "RemoteModel")
\u2022 A title the user can rename
\u2022 Its position on the canvas (x, y coordinates)
\u2022 Input and output ports (connection points)
\u2022 Parameters specific to that node type (e.g., which model to use)
\u2022 Metadata: name, description, notes, and tags
\u2022 Annotations: behavioral intent and flags (async, stateful, etc.)</code></pre>

    <h3>Ports and Edges</h3>
    <p>Ports are the connection points on each node. Input ports are on the left, output ports on the right. An edge (connection line) runs from one node's output port to another node's input port, defining the flow of data.</p>
    <p>Port types are descriptive labels (Data, Control, Signal) that help users understand what kind of information flows through, but aren't enforced by the system.</p>
  `;
}

function renderKBAgents() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Agents</h2>
    <p>Agents are AI personas with defined roles, capabilities, and behaviors. They represent the intelligent actors in a BentoBase workflow.</p>

    <h3>What is an Agent?</h3>
    <p>An agent is like a team member with a specific job description. Each agent has:</p>
    <pre><code>\u2022 A name, avatar, and short descriptor
\u2022 A classification (its role on the team \u2014 see below)
\u2022 Requested capabilities (which AI models, data sources, and tools it needs)
\u2022 Memory settings (how it remembers context between interactions)
\u2022 Behavior settings (communication tone and style)
\u2022 Collaborators (other agents it works with)</code></pre>

    <h3>Agent Classifications</h3>
    <p>Every agent is assigned one of five roles:</p>
    <table class="kb-table">
      <thead><tr><th>Classification</th><th>Role</th><th>Example</th></tr></thead>
      <tbody>
        <tr><td><strong>Observer</strong></td><td>Watches for inputs and converts raw signals into structured data</td><td>A monitoring agent that watches for system events</td></tr>
        <tr><td><strong>Analyst</strong></td><td>Interprets data, identifies patterns, and generates plans</td><td>A research agent that analyzes documents</td></tr>
        <tr><td><strong>Orchestrator</strong></td><td>Coordinates other agents and decides which workflows to run</td><td>A manager agent that delegates tasks</td></tr>
        <tr><td><strong>Operator</strong></td><td>Takes action \u2014 uses tools, runs flows, and produces output</td><td>A writer agent that generates content</td></tr>
        <tr><td><strong>Archivist</strong></td><td>Manages memory, retrieval, and long-term knowledge storage</td><td>A librarian agent that indexes and recalls information</td></tr>
      </tbody>
    </table>

    <h3>Agents in Flows</h3>
    <p>Users can drag agents from the inspector's Agents tab directly onto the canvas. This creates an Agent node with one input and one output port. The node references the original agent by ID, so changes to the agent definition are reflected everywhere it's used.</p>

    <h3>Agent Server</h3>
    <p>Agents are managed by a dedicated server (running on port 3009) that handles creating, reading, updating, and deleting agent records. The UI talks to this server through a REST API client.</p>
  `;
}

function renderKBDataInterfaces() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Data & Interfaces</h2>

    <h3>Data Tab</h3>
    <p>The Data tab is where users manage the information sources that feed into their flows. It includes:</p>
    <pre><code>\u2022 Connections \u2014 Links to external data sources (databases, APIs, services)
\u2022 Files \u2014 Uploaded documents, images, and other files stored locally
\u2022 Knowledge Bases \u2014 Collections of indexed documents for retrieval-augmented generation
\u2022 File Upload \u2014 Drag-and-drop or file picker for bringing new files into the system
\u2022 Data Preview \u2014 Quick view of file contents and metadata before using in a flow</code></pre>
    <p>All data stays local to the user's machine unless they explicitly configure a remote connection.</p>

    <h3>Interfaces Tab</h3>
    <p>The Interfaces tab lets users build front-end experiences that connect to their flows. Think of it as a simple UI builder:</p>
    <pre><code>\u2022 Interface Editor \u2014 Visual editor for arranging UI components
\u2022 Layout \u2014 Grid and flex-based positioning of elements
\u2022 Components \u2014 Pre-built elements (text inputs, buttons, displays, file pickers)
\u2022 Preview \u2014 Live preview of the interface before publishing</code></pre>
    <p>Interfaces allow non-technical users to interact with complex flows through simple forms and dashboards rather than the node canvas.</p>

    <h3>Key Files</h3>
    <p>Data-related functionality lives primarily in the storage layer. Interface building is handled in the UI layer with its own editor and component library.</p>
  `;
}

function renderKBCommunityShowcase() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Community & Showcase</h2>
    <p>BentoBase is not just an editor \u2014 it is a publishing and exchange layer where individuals, communities, and enterprises share agents, flows, and the outputs those designs produce.</p>

    <h3>Showcase</h3>
    <p>A browsable gallery of published artifacts and experiences \u2014 dashboards, interactive films, games, music, educational applications, templates, and personal uploads \u2014 meant to be experienced first, inspected second.</p>
    <pre><code>\u2022 App Gallery \u2014 Grid of featured community-built applications and experiences
\u2022 Full-Screen Viewer \u2014 Immersive view of individual showcase items
\u2022 Featured Apps \u2014 Highlighted picks chosen by the team
\u2022 Categories \u2014 Browse by use case (productivity, creative, research, etc.)</code></pre>

    <h3>Marketplace</h3>
    <p>A monetization layer where creators can sell or license agents, flows, interfaces, and artifacts. Enterprises can procure vetted components. Organizations can publish internal catalogs with policy gating.</p>
    <pre><code>\u2022 Browse & Discover \u2014 Find shared flows, agents, and templates from other users
\u2022 Discussion \u2014 Threaded conversations about best practices, troubleshooting, and ideas
\u2022 My Store \u2014 A personal storefront for publishing and managing shared items
\u2022 Ratings & Reviews \u2014 Community-driven quality signals
\u2022 Search & Filter \u2014 Find items by category, tags, rating, or text search</code></pre>
    <p>The marketplace supports 3D tilt effects on cards and collapsible category sections. User avatars show photo images when available.</p>

    <h3>Sharing Model</h3>
    <p>Every shared item ships with provenance, permissions, and an inspectable graph. What it does is visible. What it touches is declared. What it costs is understandable. What it exports is explicit.</p>

    <h3>Key Files</h3>
    <p>Community features are implemented across <code>community.js</code>, <code>communityMarketplace.js</code>, and <code>communityMyStore.js</code> in the UI layer.</p>
  `;
}

function renderKBLoginSettings() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Login & Settings</h2>

    <h3>Login Screen</h3>
    <p>The login screen is the first thing users see when opening BentoBase. It includes:</p>
    <pre><code>\u2022 PIN Entry \u2014 Numeric passcode input for quick local access
\u2022 Authentication Flow \u2014 The sequence from PIN entry to authenticated session
\u2022 Session Management \u2014 Tracking active sessions and handling timeouts
\u2022 Splash Screen \u2014 Brief branded loading screen shown on app start
\u2022 Error States \u2014 Messages for wrong PIN, locked out, etc.
\u2022 Lockout Logic \u2014 Temporary lock after too many failed attempts</code></pre>
    <p>Authentication is local \u2014 there's no remote auth server. The PIN protects local data access on the user's machine.</p>

    <h3>Settings</h3>
    <p>The Settings page lets users configure the app to their preferences:</p>
    <pre><code>\u2022 API Providers \u2014 Configure which AI model providers to use (OpenAI, Anthropic, local models, etc.)
\u2022 Backend Services \u2014 Set up connections to supporting services
\u2022 MCP Servers \u2014 Manage Model Context Protocol servers for flow execution
\u2022 Account \u2014 User profile, display name, preferences
\u2022 Theme \u2014 Choose between 6 visual themes (see Theming section)</code></pre>
    <p>Settings persist locally and are never sent to external servers.</p>
  `;
}

function renderKBSecurity() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Security</h2>
    <p>BentoBase follows a sovereignty-first security model. User data stays on their machine, and all external communication is opt-in.</p>

    <h3>Security Principles</h3>
    <pre><code>\u2022 Local-first \u2014 All data is stored on the user's machine, not in the cloud
\u2022 Opt-in remote \u2014 Cloud services (AI APIs, MCP servers) require explicit configuration
\u2022 No telemetry \u2014 The app does not phone home or collect usage data
\u2022 PIN protection \u2014 Local access is gated behind a numeric PIN</code></pre>

    <h3>Areas of Concern</h3>
    <table class="kb-table">
      <thead><tr><th>Area</th><th>What to watch for</th></tr></thead>
      <tbody>
        <tr><td>Auth & Identity</td><td>PIN storage, session tokens, lockout enforcement</td></tr>
        <tr><td>Data Encryption</td><td>Sensitive data at rest (API keys, credentials)</td></tr>
        <tr><td>Input Validation</td><td>Sanitizing user inputs to prevent XSS or injection</td></tr>
        <tr><td>Permissions</td><td>What each part of the app can access and modify</td></tr>
        <tr><td>API Keys & Secrets</td><td>Safe storage and transmission of provider API keys</td></tr>
        <tr><td>CSP & Sandboxing</td><td>Content Security Policy headers, Electron sandboxing</td></tr>
      </tbody>
    </table>

    <h3>Electron Considerations</h3>
    <p>When running as a desktop app via Electron, additional security measures apply: the renderer process is sandboxed, Node.js integration follows Electron security best practices, and file system access is scoped to the app's data directory.</p>
  `;
}

function renderKBThemes() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Theming & UX</h2>
    <p>BentoBase uses a CSS custom property system for theming. Every color in the app references a theme variable, so switching themes instantly changes the entire look.</p>

    <h3>Available Themes</h3>
    <table class="kb-table">
      <thead><tr><th>Theme</th><th>Feel</th><th>Background</th><th>Accent</th></tr></thead>
      <tbody>
        <tr><td>Marshmallow</td><td>Light, warm, earthy</td><td>Soft white</td><td style="color:#7c5b45">Warm brown</td></tr>
        <tr><td>Mocha</td><td>Dark, warm, caramel</td><td>Deep brown</td><td style="color:#e2b88f">Golden caramel</td></tr>
        <tr><td>Disco</td><td>Dark, neon, vibrant</td><td>Deep purple</td><td style="color:#00f5ff">Electric cyan</td></tr>
        <tr><td>Ron Swanson</td><td>Dark, leather, whiskey</td><td>Navy blue</td><td style="color:#f6c177">Amber gold</td></tr>
        <tr><td>Gringo</td><td>Light, sandy, desert</td><td>Warm sand</td><td style="color:#0a8f6a">Cactus green</td></tr>
        <tr><td>Matrix</td><td>Dark, digital, retro</td><td>Near black</td><td style="color:#00ff66">Terminal green</td></tr>
      </tbody>
    </table>

    <h3>How Theming Works</h3>
    <p>Each theme defines a set of color variables. Every component in the app uses these variables instead of hard-coded colors. The key variables are:</p>
    <pre><code>\u2022 --bg          \u2192 Page background
\u2022 --panel       \u2192 Panel and sidebar backgrounds
\u2022 --panel2      \u2192 Cards, modals, and elevated surfaces
\u2022 --text        \u2192 Primary text color
\u2022 --muted       \u2192 Secondary text, labels, subtle elements
\u2022 --border      \u2192 Border color (used at low opacity via color-mix)
\u2022 --focus       \u2192 Accent color for interactive elements
\u2022 --accentBg    \u2192 Filled button backgrounds
\u2022 --accentText  \u2192 Text on accent-colored backgrounds</code></pre>

    <h3>UX Patterns</h3>
    <pre><code>\u2022 Consistent 44px header height across the app
\u2022 Uppercase 11px tab labels with bottom-border underlines
\u2022 Subtle hover transitions (150ms) on all interactive elements
\u2022 color-mix() for theme-aware transparency (instead of rgba)
\u2022 6px scrollbars that blend with the theme
\u2022 Empty states with centered icon + message pattern</code></pre>

    <h3>Adding a New Theme</h3>
    <p>To add a theme, define a new set of color variables under a theme attribute selector in the CSS. Then add the theme name to the theme selector dropdown in the app shell.</p>
  `;
}

function renderKBToneVoice() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Tone & Voice</h2>
    <p>BentoBase is designed to feel like a calm, inspiring, and accessible space. The experience should invite people in rather than overwhelm them. Every screen, message, and interaction reinforces the idea that this is a place where builders of all skill levels can explore AI on their own terms.</p>

    <h3>Overall Feeling</h3>
    <p>The app aims to be:</p>
    <pre><code>\u2022 Calm \u2014 Unhurried, spacious layouts with breathing room. No flashing alerts, aggressive upsells, or attention-grabbing tricks.
\u2022 Inspiring \u2014 Encourages curiosity and creative exploration. The interface rewards experimentation rather than punishing mistakes.
\u2022 Accessible \u2014 Welcoming to non-technical users. Plain language over jargon. Clear labels, helpful empty states, and gentle guidance.
\u2022 Sovereign \u2014 Reinforces that the user is in control. Their data stays local, their choices are respected, and they are never locked in.</code></pre>

    <h3>Splash Screen</h3>
    <p>When BentoBase starts (or when the app is locked), a splash screen greets the user with the animated Bento grid loader, a theme selector, and server health indicators. Rotating text cycles through two types of content:</p>

    <h4>Philosophical Quotes</h4>
    <p>The majority of splash content is drawn from a curated collection of around 60 quotes from philosophers, poets, and writers spanning thousands of years. These are not motivational posters or productivity slogans. They are reflective, timeless observations about awareness, purpose, resilience, and the human experience. Sources include:</p>
    <pre><code>\u2022 Stoic philosophers \u2014 Marcus Aurelius, Epictetus, Seneca
\u2022 Existentialists \u2014 Kierkegaard, Camus, Sartre, Nietzsche, Frankl
\u2022 Eastern wisdom \u2014 Laozi, Buddha
\u2022 Classical thinkers \u2014 Socrates, Aristotle, Heraclitus
\u2022 Poets and writers \u2014 Rilke, Rumi, Emily Dickinson, Mary Oliver, Leonard Cohen, T. S. Eliot, Tolkien, Hemingway, Steinbeck, Oscar Wilde
\u2022 Biblical wisdom \u2014 Proverbs and Psalms (guidance, trust, patience, and the search for understanding)
\u2022 Civil rights voices \u2014 Martin Luther King Jr., Toni Morrison, Zora Neale Hurston</code></pre>
    <p>The quotes share a common thread: they speak to inner strength, self-knowledge, the courage to begin, and finding meaning in difficulty. They set a contemplative mood that distinguishes BentoBase from typical developer tooling.</p>

    <h4>Practical Tips</h4>
    <p>Interspersed with the quotes are short usage tips prefixed with "Tip:" that teach canvas shortcuts and workflow best practices. Examples include keyboard shortcuts (Space+drag to pan, F to reset zoom), node design advice (keep node bodies clean, write descriptions as full sentences), and connection guidance (masking nodes sit between inputs and models). These help new users learn the app while waiting for services to come online.</p>

    <h3>Sovereignty Statement</h3>
    <p>The splash screen includes a dedicated "AI Sovereignty" note in the corner. It advises users to develop AI that is fully under their control \u2014 to know what models are used, when and how data travels, and to be in full agreement with every action AI performs. It links to the full source code download. This is not a legal disclaimer; it is a statement of values.</p>

    <h3>Design and Tone (Canonical)</h3>
    <p>Calm, modern, confident, and obvious. No "AI magic" aesthetics. No hidden state. No cute metaphors. Clarity beats cleverness. Motion is subtle and functional. The UI teaches through plain language and consistent diagram grammar.</p>

    <h3>Guiding Principles for New Content</h3>
    <p>When writing labels, messages, empty states, or any user-facing text in BentoBase, follow these principles:</p>
    <pre><code>\u2022 Use plain, human language \u2014 say "saved flows" not "persisted flow artifacts"
\u2022 Be encouraging, not demanding \u2014 "Drag a node to get started" not "You must create a node"
\u2022 Respect the user's intelligence \u2014 clear does not mean dumbed down
\u2022 Avoid urgency and pressure \u2014 no countdowns, no "act now" language, no artificial scarcity
\u2022 Prefer warmth over formality \u2014 conversational but not sloppy
\u2022 Let the work speak for itself \u2014 the app earns trust through transparency, not marketing
\u2022 No "AI magic" language \u2014 the system is explicit, not magical</code></pre>

    <h3>The Closing Tagline</h3>
    <p>"Build systems that deserve to exist." This phrase appears across the About page and Design Partners materials. It captures the aspiration: BentoBase is for people who care about what they build and how it affects others.</p>

    <h3>Canonical One-Line Statement</h3>
    <p>BentoBase is the MCP-native control plane and marketplace for agentic systems \u2014 where workflows are authored as explicit graphs, governed by policy, executed by a separate runtime, integrated with enterprise systems by contract, and published as shareable agents, flows, and interactive outputs.</p>
  `;
}

function renderKBConventions() {
  document.getElementById("kb-content").innerHTML = `
    <h2>Conventions</h2>
    <p>BentoBase follows consistent patterns throughout the codebase. Understanding these helps keep changes clean and predictable.</p>

    <h3>Naming Patterns</h3>
    <table class="kb-table">
      <thead><tr><th>What</th><th>Style</th><th>Examples</th></tr></thead>
      <tbody>
        <tr><td>File names</td><td>camelCase with .js extension</td><td>dragCreate.js, nodeView.js, agentEditor.js</td></tr>
        <tr><td>Functions</td><td>camelCase, often verb-first</td><td>renderLibraryTab(), getNodeSize(), createEdge()</td></tr>
        <tr><td>Constants</td><td>ALL_CAPS with underscores</td><td>NODE_CATEGORIES, ACTION_TYPE</td></tr>
        <tr><td>CSS classes</td><td>kebab-case with component prefix</td><td>.library-tab-item, .badge-critical, .node-agent</td></tr>
        <tr><td>Object IDs</td><td>prefix + underscore + UUID</td><td>node_abc123, flow_def456, agent_xyz789</td></tr>
      </tbody>
    </table>

    <h3>CSS Organization</h3>
    <p>All visual styles live in a single file (<code>src/app.css</code>). Sections are separated by comment headers. When adding new components, follow the pattern of existing ones (e.g., <code>.library-tab-*</code> or <code>.agents-tab-*</code>). Use <code>color-mix()</code> for theme-aware transparency instead of hard-coded rgba values.</p>

    <h3>State Management Rules</h3>
    <pre><code>\u2022 Never change state directly \u2014 always go through the action/dispatch system
\u2022 The reducer creates new state objects (doesn't modify existing ones)
\u2022 Side effects (saving files) happen after the state update
\u2022 The UI re-renders from state \u2014 it never stores its own separate copy of the data
\u2022 Simple variables (let) are used for UI-only state like search filters and selections</code></pre>

    <h3>Import Style</h3>
    <p>The app uses standard JavaScript module imports with full file extensions (no bundler). Imports use named exports and relative paths from the importing file.</p>
    <pre><code>import { ActionType } from "../state/actions.js";
import { loadFlow, saveFlow } from "../storage/flows.js";</code></pre>

    <h3>Key Rules for Contributors</h3>
    <pre><code>\u2022 Keep changes minimal and focused on the specific task
\u2022 Mirror existing patterns rather than inventing new ones
\u2022 Test empty states, error states, and edge cases
\u2022 Don't add dependencies \u2014 the app has zero external libraries
\u2022 Preserve existing behavior when refactoring
\u2022 All data persistence is local-first by default</code></pre>
  `;
}

// === ROADMAP ===
function renderRoadmap() {
  const cols = ["open", "progress", "review", "done"];
  const labels = { open: "Backlog", progress: "In Progress", review: "In Review", done: "Completed" };

  const grouped = {};
  cols.forEach(c => grouped[c] = []);
  DATA.tickets.forEach(t => {
    if (grouped[t.status]) grouped[t.status].push(t);
  });

  // Sort each column by priority
  const pw = { critical: 0, high: 1, medium: 2, low: 3 };
  cols.forEach(c => grouped[c].sort((a, b) => pw[a.priority] - pw[b.priority]));

  document.getElementById("page-roadmap").innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <div class="page-title">Roadmap</div>
      <button class="btn btn-primary" onclick="openNewTicketModal()">+ New Ticket</button>
    </div>
    <div class="page-subtitle">Kanban board view of all work items</div>

    <div class="roadmap-cols">
      ${cols.map(col => `
        <div class="roadmap-col">
          <div class="roadmap-col-header">
            ${labels[col]}
            <span class="roadmap-count">${grouped[col].length}</span>
          </div>
          <div class="roadmap-cards" data-status="${col}">
            ${grouped[col].length === 0 ? `<div class="empty-state" style="padding:24px 12px"><div class="empty-state-sub">No items</div></div>` :
              grouped[col].map(t => `
                <div class="roadmap-card" draggable="true" data-ticket-id="${t.id}" onclick="openTicketDetail('${t.id}')">
                  ${t.image ? `<img class="roadmap-card-image" src="data:image/png;base64,${t.image}" alt="" loading="lazy" />` : ``}
                  <div class="roadmap-card-title">${esc(t.title)}</div>
                  <div class="roadmap-card-meta">
                    <span class="badge badge-${t.type}" style="font-size:9px">${esc(t.type)}</span>
                    <span class="badge badge-${t.priority}" style="font-size:9px">${esc(t.priority)}</span>
                    ${t.area ? `<span class="badge badge-area" style="font-size:9px">${esc(getAreaLabel(t.area))}</span>` : ""}
                    ${t.assignee ? `<span style="font-size:10px;color:var(--muted);margin-left:auto">${esc(t.assignee)}</span>` : ""}
                  </div>
                </div>
              `).join("")}
          </div>
        </div>
      `).join("")}
    </div>
  `;

  // --- Bind drag-and-drop ---
  initRoadmapDragDrop();
  // --- Bind 3D tilt ---
  initRoadmapTilt();
}

// --- Roadmap drag-and-drop ---
let roadmapDragId = null;

function initRoadmapDragDrop() {
  const cards = document.querySelectorAll(".roadmap-card[draggable]");
  const columns = document.querySelectorAll(".roadmap-cards");

  cards.forEach(card => {
    card.addEventListener("dragstart", e => {
      roadmapDragId = card.dataset.ticketId;
      card.classList.add("dragging");
      e.dataTransfer.effectAllowed = "move";
      e.dataTransfer.setData("text/plain", roadmapDragId);
      // Prevent click from firing after drag
      card._dragStarted = true;
    });

    card.addEventListener("dragend", () => {
      card.classList.remove("dragging");
      columns.forEach(col => col.classList.remove("drag-over"));
      roadmapDragId = null;
      // Suppress click after drag
      setTimeout(() => { card._dragStarted = false; }, 0);
    });

    // Override onclick to suppress after drag
    const origClick = card.onclick;
    card.onclick = function(e) {
      if (this._dragStarted) { this._dragStarted = false; return; }
      if (origClick) origClick.call(this, e);
    };
  });

  columns.forEach(col => {
    col.addEventListener("dragover", e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
      col.classList.add("drag-over");
    });

    col.addEventListener("dragleave", e => {
      // Only remove if leaving the column itself
      if (!col.contains(e.relatedTarget)) {
        col.classList.remove("drag-over");
      }
    });

    col.addEventListener("drop", e => {
      e.preventDefault();
      col.classList.remove("drag-over");
      const ticketId = e.dataTransfer.getData("text/plain");
      const newStatus = col.dataset.status;
      if (!ticketId || !newStatus) return;

      const t = DATA.tickets.find(x => x.id === ticketId);
      if (!t || t.status === newStatus) return;

      const oldStatus = t.status;
      t.status = newStatus;
      t.updatedAt = now();
      const statusLabel = { open: "Backlog", progress: "In Progress", review: "Review", done: "Done" };
      const act = {
        action: newStatus === "done" ? "complete" : "update",
        ticketId: t.id,
        title: `${t.title} \u2192 ${statusLabel[newStatus] || newStatus}`,
        time: now()
      };
      addActivity(act.action, act.ticketId, act.title);
      apiUpdateTicket(t.id, { status: t.status, updatedAt: t.updatedAt }, act);
      renderRoadmap();
      showToast(`Moved to ${statusLabel[newStatus] || newStatus}`);
    });
  });
}

// --- Roadmap 3D tilt (Apple TV style) ---
function initRoadmapTilt() {
  const cards = document.querySelectorAll(".roadmap-card");
  const MAX_TILT = 4; // degrees — subtle

  cards.forEach(card => {
    card.addEventListener("mousemove", e => {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const rotateY = ((x - centerX) / centerX) * MAX_TILT;
      const rotateX = ((centerY - y) / centerY) * MAX_TILT;
      card.style.transform = `perspective(600px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-1px)`;
    });

    card.addEventListener("mouseleave", () => {
      card.style.transform = "";
    });
  });
}

// --- Tracker 3D tilt (Netflix card hover) ---
function initTrackerTilt() {
  const cards = document.querySelectorAll(".nf-card");
  const MAX_TILT = 4;

  cards.forEach(card => {
    card.addEventListener("mousemove", e => {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      const rotateY = ((x - centerX) / centerX) * MAX_TILT;
      const rotateX = ((centerY - y) / centerY) * MAX_TILT;
      card.style.transform = `perspective(600px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.03)`;
    });

    card.addEventListener("mouseleave", () => {
      card.style.transform = "";
    });
  });
}

// --- Boot: load data from server, migrate localStorage, render ---
(async function boot() {
  // Attempt migration first
  await migrateLocalStorage();

  // Load data from server
  DATA = await loadDataFromServer();

  // Load and apply settings
  const settings = await loadSettingsFromServer();
  document.documentElement.setAttribute("data-theme", settings.theme || "marshmallow");
  themeSelect.value = settings.theme || "marshmallow";
  hasAnthropicKey = settings.hasAnthropicKey || false;
  anthropicKeyHint = settings.anthropicKeyHint || "";
  hasOpenAIKey = settings.hasOpenAIKey || false;
  openaiKeyHint = settings.openaiKeyHint || "";
  imageStylePrompt = settings.imageStylePrompt || "";
  hasFreepikKey = settings.hasFreepikKey || false;
  freepikKeyHint = settings.freepikKeyHint || "";
  imageProvider = settings.imageProvider || "openai";

  // Initial render
  renderDashboard();
})();
</script>
</body>
</html>
